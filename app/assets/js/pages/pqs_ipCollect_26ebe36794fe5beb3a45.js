webpackJsonp([16],{646:function(t,e,a){"use strict";(function(e,o,r,n){function u(t,a){l={data:{keypartCode:"",supplierCode:"",lotNum:"",keypartText:"",supplierText:"",subAssemblyFlag:"",statusEcode:"",alternateGroup:"",quantity:""},relation:{A0809:{alternateGroup:"111"},B0809:{alternateGroup:"222"},S0809:{alternateGroup:"111"}},group:{111:{count:0,maxCount:"3"},222:{count:0,maxCount:"2"}},emptyNormalFlag:"",lotBarCode:"",station:t||{stationCode:"",stationText:""},params013:{siteCode:e.siteCode,stationCode:t.stationCode},params001:{serviceCode:"GMES-CLIENT-KEYPART001",siteCode:e.siteCode,stationCode:t.stationCode,productNum:"",createUser:C,modifyUser:C,subAssemblyFlag:0,statusECode:""},dataTable:null,selectRow:null,$currentNum:o("#currentNum"),$allNum:o("#allNum"),$productmark:o("#productmark"),$lotBarCodeInput:o("#lotBarCodeInput"),$ipCollectBatchNumber:o("#ipCollect-batchNumber"),userCode:C,undoCount:0,$table:o(".ipCollect .table-panel table"),dataTableConfig:{serverSide:!1,paging:!1,searching:!1,scrollY:a.page.height-158-30,order:[],ordering:!1,data:[],dom:"<'row'<'col-50'f>> <'row'<'col-100'tr>> <'row'<'col-50'p>>",columns:[{data:"keypartCode",render:function(t,e,a){return"<span class='ipCollect-component-value'>"+a.keypartCode+"</span>"}},{data:"supplierCode",render:function(t,e,a){return"<a class='f-cp ipCollect-open-picker-supplier-value ipCollect-open-picker'>"+a.supplierCode+"</a>"}},{data:"lotNum",render:function(t,e,a){return"<a class='f-cp ipCollect-open-picker-batch-value  ipCollect-open-picker'>"+a.lotNum+"</a>"}},{data:"keypartText"},{data:"supplierText"},{render:function(){return"<button class='cancel'>"+r.t("KEYPART.B.REPEAL")+"</button>"}}],rowCallback:function(t,e){2==e.statusEcode&&(o(t).children().addClass("error"),o(t).children("td").children("button").addClass("delBtn")),!0===e.invalid&&o(t).addClass("invalid")}}}}var l,i=a(113),s=function(t){return t&&t.__esModule?t:{default:t}}(i),d=a(35),c=a(78),p=a(34),C=d.getUserProfile().userCode,f={page:void 0,init:function(){var t=this;p.translate(this.page),d.isUniqueOperableStation(function(e){u(e,t),l.dataTable=l.$table.DataTable(l.dataTableConfig),p.service("GMES-CLIENT-KEYPART013",l.params013).done(function(e){p.rightCode(e,function(e){!0===e.data?(p.setBreadcrumb([r.t("KEYPART.T.MENU_COLLECT")+" "+l.station.stationCode]),t.event()):n.force({type:3,text:r.t("COMMON.T.MSG_INVALID_PERMISSIONS"),buttonText:"知道了",callback:function(){p.returnHome()}})})})})},event:function(){o("#productmark").focus(),o(".close-picker").on("click",function(){o("#lotBarCodeInput").focus()}),this.saveEvent(),this.tableEvent(),this.productmarkEvent(),this.lotBarCodeInputEvent(),this.confirmEvent(),this.deleteEvent()},tableEvent:function(){var t=this;o(".table-panel tbody").on("click","tr:not(.invalid)",function(e){o(e.target).hasClass("dataTables_empty")||o(e.target).hasClass("cancel")||(l.selectRow=l.dataTable.row(this),t.setInputVal(),t.selectDefaultVendor().then(function(){myApp.popup(".picker-modal")}))})},setInputVal:function(){var t=l.selectRow.data();o("#ipCollect-component").val(t.keypartCode),o("#ipCollect-batchNumber").val(t.lotNum)},setStatusEcode:function(t,a,o){return new s.default(function(r){var n=2;""===t&&""===a?(n=0,r(n)):""!==t&&""!==a?1==o?(n=1,r(n)):1!=o?p.service("GMES-CLIENT-KEYPART011",{siteCode:e.siteCode,materialCode:l.selectRow.data().keypartCode,supplierCode:t},"正在检验物料供应商关系").done(function(t){p.rightCode(t,function(t){!0===t.data&&(n=1,r(n))})}):r(n):r(n)})},getCountChange:function(t,e){var a,o=0;return e=parseInt(e),a=0===e||!e,a&&0!==t?o=-1:e>0&&0===t&&(o=1),l.undoCount+=o,l.$currentNum.text(l.undoCount),o},deleteEvent:function(){var t=this;o(".table-panel tbody").on("click",".cancel",function(){l.selectRow=l.dataTable.row(o(this).parents("tr"));var e=l.selectRow.data();(e.supplierCode||e.lotNum||e.supplierText)&&(e.supplierCode=e.lotNum=e.supplierText="",t.saveToTable(e))})},confirmEvent:function(){var t=this;o(".ipCollect").on("click",".ipCollect-confirm",function(){var e=l.selectRow.data();e.supplierCode=o('input:radio[name="provider"]:checked').val()||"",e.lotNum=o("#ipCollect-batchNumber").val().toUpperCase()||"",e.supplierText=o('input:radio[name="provider"]:checked').next().children("span").text()||"",t.saveToTable(e),myApp.closeModal(".picker-info")})},sortData:function(t){var e=l.dataTable.data(),a=l.selectRow.index();if(e.splice(a,1),e.length>1){var o=e[0];1!=o.statusEcode&&2!=o.statusEcode||(e.shift(),e.push(o))}return e.unshift(t),l.dataTable.clear(),l.dataTable.rows.add(e),l.$table.parent().scrollTop(0),e},setInvalid:function(t,e){var a=t.keypartCode;if(l.relation[a]){var o=!1,r=l.relation[a].alternateGroup;l.group[r].count-=e,l.group[r].count>=l.group[r].maxCount&&(o=!0),l.dataTable.rows(function(t,e){return e.alternateGroup===r&&1!=e.statusEcode&&2!=e.statusEcode}).every(function(){this.data().invalid=o})}},saveToTable:function(t){var e=this;this.setStatusEcode(t.supplierCode,t.lotNum,t.subAssemblyFlag).then(function(a){var o=e.getCountChange(a,t.statusEcode);t.statusEcode=a,e.sortData(t),e.setInvalid(t,o),l.dataTable.draw()})},emptySaveAajx:function(){l.params001.productNum=l.$productmark.val().toUpperCase(),l.params001.statusECode=l.emptyNormalFlag,e.request({url:"restful/service/execute",data:l.params001,success:function(t){"0"===t.returnCode?n.alert({type:"1",text:"标记成功！"}):n.alert({text:t.errorMessage})}}),l.$productmark.focus().select()},emptySave:function(){var t=this;myApp.modal({title:"iME提示",text:"清单为空，跳过请标记",buttons:[{text:"异常",onClick:function(){l.emptyNormalFlag="30",t.emptySaveAajx()}},{text:"正常",bold:!0,onClick:function(){l.emptyNormalFlag="20",t.emptySaveAajx()}}]})},disabledInput:function(t,e){t.attr("disabled",e)},getListDataFromServer:function(){var t=this;p.service("GMES-CLIENT-KEYPART003",{siteCode:e.siteCode,stationCode:l.station.stationCode,productNum:l.$productmark.val().toUpperCase()},"正在获取扫描清单").done(function(e){p.rightCode(e,t.createTable,t)}).fail(function(){l.$productmark.focus().select()})},emptyList:function(t){t?this.emptySave():(n.alert({text:r.t("KEYPART.T.MSG_RECORDLIST_IS_EMPTY")}),l.dataTable.clear().draw(),l.$productmark.focus().select())},fullList:function(t){for(var e=t.quantity,a=[],r=0;r<e;r++)t.lotNum="",t.supplierCode="",a.push(o.extend(!0,{},t));return a},removeNull:function(t){return t.lotNum||(t.lotNum=""),t.supplierCode||(t.supplierCode=""),t},renderCount:function(t,e){l.$allNum.text(t),l.undoCount=t-(e||0),l.$currentNum.text(l.undoCount)},firstCollect:function(t){var e=this,a=0,o=[],r=l.relation={};return l.group={},c.forEach(t,function(t){var n=t.quantity,u=t.alternateGroup,i=t.keypartCode;o=o.concat(e.fullList(t)),u?(r[i]={alternateGroup:u},l.group[u]?n>l.group[u].maxCount&&(l.group[u].maxCount=n):l.group[u]={count:0,maxCount:n}):a+=parseInt(n)}),c.forEach(l.group,function(t){a+=parseInt(t.maxCount)}),this.renderCount(a),o},continueCollect:function(t){var e=this,a=0,o=0,r=l.relation={};return l.group={},c.forEach(t,function(t){var n=t.alternateGroup,u=t.keypartCode;1!=t.statusEcode&&2!=t.statusEcode||o++,t=e.removeNull(t),n?(r[u]?r[u].maxCount+=1:r[u]={maxCount:1,alternateGroup:n},l.group[n]||(l.group[n]={maxCount:0,count:0}),1!=t.statusEcode&&2!=t.statusEcode||l.group[n].count++):a++}),c.forEach(r,function(t){var e=t.alternateGroup;t.maxCount>l.group[e].maxCount&&(l.group[e].maxCount=t.maxCount)}),c.forEach(l.group,function(t,e){a+=t.maxCount,t.count>=t.maxCount&&(l.dataTable.rows(function(t,a){return a.alternateGroup===e&&1!=a.statusEcode&&2!=a.statusEcode}).every(function(){this.data().invalid=!0}),l.dataTable.draw())}),this.renderCount(a,o),t},createTable:function(t){var e=t.data.list,a=e.length,r=t.data.first;if(a<=0)return void this.emptyList(r);r?(e=this.firstCollect(e),l.dataTable.clear(),l.dataTable.rows.add(e).draw(),l.$lotBarCodeInput.focus()):(e=this.continueCollect(e),l.dataTable.clear(),l.dataTable.rows.add(e).draw()),o(".head-confirm").removeClass("disabled")},loadTableByProductNum:function(){var t=this;p.service("GMES-CLIENT-KEYPART018",{siteCode:e.siteCode,stationCode:l.station.stationCode,productNum:l.$productmark.val().toUpperCase()},"VIN号校验中").done(function(e){p.rightCode(e,function(e){var a=e.data;"1"===a?(t.disabledInput(l.$productmark,"disabled"),t.getListDataFromServer()):"2"===a?(n.alert({type:2,text:"产品标识号不连续"}),t.disabledInput(l.$productmark,"disabled"),t.getListDataFromServer()):(o(".head-confirm").addClass("disabled"),n.alert({text:"无效的产品标识号"}),l.$productmark.focus().select())})}).fail(function(){l.$productmark.focus().select()}),o("#lotBarCodeInput").focus().select()},productmarkEvent:function(){var t=this,e=l.$productmark;e.keyup(function(a){this.value=p.filter(this.value),13==a.keyCode&&""!==this.value&&(e.focus().select(),o("div.productmark").remove(),t.loadTableByProductNum())}),l.$ipCollectBatchNumber.keyup(function(){this.value=p.filter(this.value)})},lotBarCodeInputEvent:function(){var t=l.$lotBarCodeInput,a=this;t.keyup(function(o){this.value=p.filter(this.value);var r=this.value;13==o.keyCode&&r&&(t.focus().select(),p.service("GMES-CLIENT-KEYPART002",{siteCode:e.siteCode,barcode:r.toUpperCase()}).done(function(t){p.rightCode(t,function(t){a.dealKeypartCode(t)})}).fail(function(){n.alert({text:"批次条码没有当前长度规则，可通过后台配置"}),l.$lotBarCodeInput.focus().select()}))})},dealKeypartCode:function(t){var e,a=t.data,o=a.materialCode;if(l.relation[o]&&(e=l.relation[o].alternateGroup,l.relation[e].count>=l.relation[e].maxCount))return n.alert({text:"组件数量已满！"}),void l.$lotBarCodeInput.focus().select();l.selectRow=l.dataTable.row(function(t,e){return e.materialCode===o&&!0!==e.invalid&&1!=e.statusEcode&&2!=e.statusEcode});var u=l.dataTable.row(function(t,e){return e.materialCode===o&&(1==e.statusEcode||2==e.statusEcode)}),i=l.selectRow.data(),s=u.data();if(i)i.supplierCode=a.supplierCode,i.lotNum=a.lotNum,i.supplierText=a.supplierText,a.valid?i.statusEcode=1:i.statusEcode=2,this.sortData(i),l.dataTable.draw(),n.alert({text:r.t("KEYPART.T.MSG_BATCH_NO_ANALYSE_SUCCESS")}),l.undoCount--,l.$currentNum.text(l.undoCount),e&&++l.relation[e].count>=l.relation[e].maxCount&&(l.dataTable.rows(function(t,a){return a.alternateGroup===e&&1!=a.statusEcode&&2!=a.statusEcode}).every(function(){this.data().invalid=!0}),l.dataTable.draw()),l.$lotBarCodeInput.val("").focus();else{var d="无匹配数据！";s&&(d="重复扫描！"),n.alert({text:d}),l.$lotBarCodeInput.focus().select()}},selectDefaultVendor:function(){var t=l.selectRow.data();return p.service("GMES-CLIENT-KEYPART006",{serviceCode:"GMES-CLIENT-KEYPART006",siteCode:e.siteCode,materialCode:t.keypartCode},"正在获取默认供应商数据").done(function(e){p.rightCode(e,function(e){var a={supplierLabel:r.t("KEYPART.T.SUPPLIER"),supplierList:e.data};p.tplManager("supplierListTpl",a,"supplierListRender");var n=t.supplierCode;n&&o("input[name='provider'][value="+n+"]").attr("checked",!0)})})},saveEvent:function(){var t=this;o(".head-confirm").on("click",function(){var a={siteCode:e.siteCode,stationCode:l.station.stationCode,productNum:l.$productmark.val().toUpperCase(),createUser:l.userCode,modifyUser:l.userCode,subAssemblyFlag:0,statusECode:"10"},o=l.dataTable.data(),u=o.length;if(u<=0)return n.alert({text:"无提交数据！"}),void l.$productmark.val("").focus();for(var i=0;i<u;i++){var s=o[i];if(1==s.notNullFlag&&!0!==s.invalid&&1!=s.statusEcode&&2!=s.statusEcode)return n.alert({text:r.t("KEYPART.T.MSG_HAVE_NOT_NULL_DATA_SUBMIT",{keypartCode:s.keypartCode})}),void l.$lotBarCodeInput.focus().select();for(var d in s)if(s.hasOwnProperty(d)&&["createDate","createDateTime","modifyDate","modifyDateTime","invalid"].indexOf(d)<0){var c="items["+i+"]."+d;"statusEcode"!=d||""!=s[d]&&null!==s[d]&&s[d]?a[c]=s[d]:a[c]=0}}l.undoCount>0?myApp.confirm("数据录入不完整，确定要提交？",function(){t.submitConfirm(a)}):t.submitConfirm(a)})},saveDataSuccess:function(){myApp.hidePreloader(),n.alert({text:"保存数据成功"}),this.disabledInput(l.$productmark,!1),l.dataTable.clear().draw(),l.$allNum.text(0),l.$currentNum.text(0),l.$lotBarCodeInput.val(""),l.$productmark.val("").focus()},submitConfirm:function(t){var e=this;p.service("GMES-CLIENT-KEYPART001",t,"数据保存中...").done(function(t){p.rightCode(t,function(){e.saveDataSuccess()})}).fail(function(){myApp.modal({title:"iME",text:"数据保存失败，选择操作",buttons:[{text:"扫下一个",onClick:function(){l.dataTable.clear().draw(),l.$allNum.text(0),l.$currentNum.text(0),l.$lotBarCodeInput.val(""),l.$productmark.removeAttr("disabled").val("").focus()}},{text:"继续修改",bold:!0,onClick:function(){l.$lotBarCodeInput.focus().select()}}]})})}};t.exports=f}).call(e,a(77),a(4),a(37),a(36))}});
//# sourceMappingURL=pqs_ipCollect_26ebe36794fe5beb3a45.js.map