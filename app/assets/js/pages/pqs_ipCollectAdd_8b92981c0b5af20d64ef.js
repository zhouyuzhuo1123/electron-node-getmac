webpackJsonp([7],{647:function(t,e,a){"use strict";(function(e,o,n){var r=a(666),l=a(77),i=a(34),u={page:void 0,selectRow:null,selectRowData:null,initTable:null,table:null,supplierText:null,tableAllDataFirst:void 0,undoInfByStation:void 0,undoCountAll:void 0,tableCountAll:void 0,stationOccupy:void 0,beforeInit:function(){e(document).off("keydown");var t=this;r.getLoginUser(function(e){t.userCode=e.data.userCode}).done(function(){t.init()})},init:function(){var t=this;i.setBreadcrumb([o.t("KEYPART.T.MENU_ADDITIONAL")]),i.translate(t.page),this.$undoCount=e("#currentNum",this.page),this.$allCount=e("#allNum",this.page),this.$productmark=e("#productmark",this.page),this.$lotBarCodeInput=e("#lotBarCodeInput",this.page),this.onload(),this.productmark(),this.lotBarCodeInputEvent(),this.loadPage()},loadPage:function(){var t=this;e("#productmark").focus(),t.removeSubmitEvent();var a=t.page.height-158-30;t.$table=e(".table-panel table",t.page),t.table=e(".table-panel table",t.page).DataTable({serverSide:!1,paging:!1,searching:!1,scrollY:a,order:[],data:[],dom:"<'row'<'col-50'f>><'row'<'col-100'tr>><'row'<'col-50'p>>",columns:[{data:"keypartCode",name:"keypartCode",orderable:!1,render:function(t,e,a){return'<span class="ipCollect-component-value">'+a.keypartCode+"</span>"}},{className:"supplierCode",data:"supplierCode",name:"supplierCode",orderable:!1,render:function(t,e,a){return'<a style="cursor:pointer;" class="ipCollect-open-picker-supplier-value ipCollect-open-picker">'+(a.supplierCode||"")+"</a>"}},{className:"supplierCode",data:"lotNum",name:"lotNum",orderable:!1,render:function(t,e,a){return'<a style="cursor:pointer;" class="ipCollect-open-picker-batch-value  ipCollect-open-picker">'+(a.lotNum||"")+"</a>"}},{data:"keypartText",name:"keypartText",orderable:!1},{data:"supplierText",name:"supplierText",orderable:!1},{name:"remove",orderable:!1,render:function(){return"<button class='cancel' >"+o.t("KEYPART.B.REPEAL")+"</button>"}}],rowCallback:function(a,o){e(a).find("td:last-child button").on("click",function(o){t.selectRow=t.table.row(a);var n=t.selectRow.data();if(!e(a).hasClass("invalid")){if(e(this).parent().parent().find("td:eq(1) a").text()||e(this).parent().parent().find("td:eq(2) a").text()){n.lotBarCode="",n.lotNum="",n.supplierCode="",n.supplierText="",t.table.row(a).data(n).draw();var r=n.statusEcode;n.statusEcode=0;var l=t.selectRow.index(),i=t.table.data().toArray();i.splice(l,1);var u=i.length>1?i[0]:void 0;!u||1!=u.statusEcode&&2!=u.statusEcode||(i.splice(0,1),i.push(u)),i.unshift(n),t.table.clear(),t.undoCount++,e(a).children().removeClass("error"),e(a).children("td").children("button").removeClass("delBtn"),t.table.rows.add(i).draw();var d;r>0?(d=-1,t.undoInfByStationCheck(n.stationCode,-1),t.stationOccupy?t.$undoCount.text(t.undoInfByStation[t.stationOccupy].undoCount):t.$undoCount.text(t.undoCount)):d=0;var s=n.keypartCode;if(0!=d){var s=n.keypartCode,c=n.stationCode;if(t.alternateRelation[c]&&t.alternateRelation[c][s]){var p=t.alternateRelation[c][s].alternateForGroup;t.alternateRelation[c][p].count+=d;var C;C=t.alternateRelation[c][p].count>=t.alternateRelation[c][p].maxCount,t.table.rows(function(t,e){return e.alternateGroup===p&&e.stationCode===c&&1!=e.statusEcode&&2!=e.statusEcode}).every(function(t,e,a){this.data().invalid=C}),t.table.draw()}}}o.stopPropagation()}}),"2"==o.statusEcode?(e(a).children().addClass("error"),e(a).children("td").children("button").addClass("delBtn")):(e(a).children().removeClass("error"),e(a).children("td").children("button").removeClass("delBtn")),1==o.invalid?e(a).addClass("invalid"):e(a).removeClass("invalid"),!0===o.hideFliterByStation?e(a).addClass("hideFliterByStation"):e(a).removeClass("hideFliterByStation")}}),e("tbody",t.$table).on("click","tr:not(.invalid)",function(){t.selectRow=t.table.row(this);var a=t.selectRow.data();e("#ipCollect-component",t.page).val(a.keypartCode),e("#ipCollect-batchNumber",t.page).val(a.lotNum),e("#ipCollect-supplier",t.page).val(a.supplierCode),t.initData(),myApp.pickerModal(e(".picker-modal",t.page)),e(".masked").css("display","block")}),e(".masked").on("click",function(){e(this).css("display","none")}),e(".close-picker").on("click",function(){t.pickermodalclose("#lotBarCodeInput")}),e(".ipCollect-confirm").on("click",function(){function a(){o=""===r.supplierCode&&""===r.lotNum?0:""!==r.supplierCode&&1==s&&""!==r.lotNum?1:2,n=(0==d||!d||""==d)&&o>0?1:d>0&&0==o?-1:0,r.statusEcode=o,t.table.row(u).data(r).draw();var e=t.table.data().toArray();e.splice(u,1);var a=e.length>1?e[0]:void 0;!a||1!=a.statusEcode&&2!=a.statusEcode||(e.splice(0,1),e.push(a)),e.unshift(r),t.table.clear(),t.table.rows.add(e).draw(),t.$table.parent().scrollTop(0),t.undoCount-=n;var l=r.keypartCode,i=r.stationCode;if(t.undoInfByStationCheck(i,n),t.stationOccupy?t.$undoCount.text(t.undoInfByStation[t.stationOccupy].undoCount):t.$undoCount.text(t.undoCount),t.alternateRelation[i]&&t.alternateRelation[i][l]){var c=t.alternateRelation[i][l].alternateForGroup;t.alternateRelation[i][c].count+=n;var p;p=t.alternateRelation[i][c].count>=t.alternateRelation[i][c].maxCount,t.table.rows(function(t,e){return e.alternateGroup===c&&e.stationCode===i&&1!=e.statusEcode&&2!=e.statusEcode}).every(function(){this.data().invalid=p}),t.table.draw()}}e(".masked").css("display","none");var o,n,r=t.selectRow.data(),u=t.selectRow.index(),d=r.statusEcode;r.supplierCode=e('input:radio[name="provider"]:checked').val()||"",r.lotNum=e("#ipCollect-batchNumber").val().toUpperCase()||"",r.supplierText=e('input:radio[name="provider"]:checked').next().children("span").text()||"";var s;if(1!=r.subAssemblyFlag&&""!==r.supplierCode){var c=function(t){s=1==t.data,a()};l.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART011",siteCode:l.siteCode,materialCode:t.selectRow.data().keypartCode,supplierCode:r.supplierCode},success:function(t){i.rightCode(t,c)}})}else 1==r.subAssemblyFlag&&""!==r.supplierCode?(s=!0,a()):(s=!1,a())}),e(".boxPage").on("click",".box",function(){var a=e(this);if(!a.hasClass("focusGray")){a.parents().find("div.focusGray").removeClass("focusGray"),a.addClass("focusGray");var o=a.attr("station");o?(t.stationOccupy=o,t.table.rows().every(function(){var t=this.data();t.stationCode===o?t.hideFliterByStation=!1:t.hideFliterByStation=!0}),t.table.draw(),t.$allCount.text(t.undoInfByStation[o].total),t.$undoCount.text(t.undoInfByStation[o].undoCount)):(t.stationOccupy=!1,t.table.rows().every(function(){this.data().hideFliterByStation=!1}),t.table.draw(),t.$allCount.text(t.tableCountAll),t.$undoCount.text(t.undoCountAll))}})},onload:function(){e(".ipCollect-cancel").on("click",function(){e(".masked").css("display","none")})},productmark:function(){var t=this,a=e("#productmark",t.page);a.keyup(function(n){var r=/[^\w\.\/]/gi;if(r.test(this.value)&&(this.value=this.value.replace(r,"")),13==n.keyCode){var l=a.val();e("#ipCollectAdd-querySiteRender").empty(),e(".stationNum").text(""),l?(a.focus().select(),t.loadTableByProductNum()):i.notify({type:"3",text:o.t("KEYPART.T.MSG_PRODUCT_NO_NOT_BE_NULL")},function(){a.focus()})}}),e("#ipCollect-batchNumber",this.page).keyup(function(){var t=/[^\w\.\/]/gi;t.test(this.value)&&(this.value=this.value.replace(t,""))})},loadTableByProductNum:function(){function t(t){var r=t.data.list,l=r.length;if(a.First=t.data.first,l<=0)return n.alert({type:"3",text:o.t("KEYPART.T.MSG_RECORDLIST_IS_EMPTY")}),a.table.clear().draw(),void a.$productmark.focus().select();a.undoInfByStation={};var i=0;if(a.addSubmitEvent(),a.First){var u=[],d=0;a.alternateRelation={};for(var s=0;s<l;s++){for(var c=r[s].quantity,p=0;p<c;p++){var C={};C=e.extend(C,r[s]),C.supplierCode="",C.lotNum="",u.push(C)}a.undoInfByStation[r[s].stationCode]||(a.undoInfByStation[r[s].stationCode]={stationCode:r[s].stationCode,stationIndex:i,doneCount:0,total:0},i++),r[s].alternateGroup?(a.alternateRelation[r[s].stationCode]||(a.alternateRelation[r[s].stationCode]={}),a.alternateRelation[r[s].stationCode][r[s].keypartCode]={alternateForGroup:r[s].alternateGroup},a.alternateRelation[r[s].stationCode][r[s].alternateGroup]?c>a.alternateRelation[r[s].stationCode][r[s].alternateGroup].maxCount&&(a.alternateRelation[r[s].stationCode][r[s].alternateGroup].maxCount=c):a.alternateRelation[r[s].stationCode][r[s].alternateGroup]={isGroup:!0,count:0,maxCount:c}):(d+=parseInt(c),a.undoInfByStation[r[s].stationCode].total+=parseInt(c))}for(var f in a.alternateRelation)for(var v in a.alternateRelation[f])a.alternateRelation[f][v].isGroup&&(d+=parseInt(a.alternateRelation[f][v].maxCount),a.undoInfByStation[f].total+=parseInt(a.alternateRelation[f][v].maxCount));a.$allCount.text(d),a.$undoCount.text(d),a.undoCount=d,a.tableCountAll=d,a.table.clear(),a.table.rows.add(u).draw(),a.$lotBarCodeInput.focus()}else{a.table.clear(),a.table.rows.add(r).draw();var d=0,m=0;a.alternateRelation={};for(var s=0;s<l;s++)a.undoInfByStation[r[s].stationCode]||(a.undoInfByStation[r[s].stationCode]={stationCode:r[s].stationCode,stationIndex:i,doneCount:0,total:0},i++),1!=r[s].statusEcode&&2!=r[s].statusEcode||(m++,a.undoInfByStation[r[s].stationCode].doneCount++),r[s].alternateGroup?(a.alternateRelation[r[s].stationCode]||(a.alternateRelation[r[s].stationCode]={}),a.alternateRelation[r[s].stationCode][r[s].keypartCode]?a.alternateRelation[r[s].stationCode][r[s].keypartCode].maxCount+=1:a.alternateRelation[r[s].stationCode][r[s].keypartCode]={maxCount:1,alternateForGroup:r[s].alternateGroup},a.alternateRelation[r[s].stationCode][r[s].alternateGroup]||(a.alternateRelation[r[s].stationCode][r[s].alternateGroup]={isGroup:!0,maxCount:0,count:0}),1!=r[s].statusEcode&&2!=r[s].statusEcode||a.alternateRelation[r[s].stationCode][r[s].alternateGroup].count++):(d++,a.undoInfByStation[r[s].stationCode].total++);for(var f in a.alternateRelation)for(var v in a.alternateRelation[f])if(!a.alternateRelation[f][v].isGroup){var y=a.alternateRelation[f][v].alternateForGroup;a.alternateRelation[f][v].maxCount>a.alternateRelation[f][y].maxCount&&(a.alternateRelation[f][y].maxCount=a.alternateRelation[f][v].maxCount)}for(var f in a.alternateRelation)for(var v in a.alternateRelation[f])a.alternateRelation[f][v].isGroup&&(d+=a.alternateRelation[f][v].maxCount,a.alternateRelation[f][v].count>=a.alternateRelation[f][v].maxCount&&a.table.rows(function(t,e,a){return e.alternateGroup===v&&e.stationCode===f&&1!=e.statusEcode&&2!=e.statusEcode}).every(function(t,e,a){this.data().invalid=!0}),a.undoInfByStation[f].total+=parseInt(a.alternateRelation[f][v].maxCount));a.table.draw(),a.$allCount.text(d),a.tableCountAll=d,a.undoCount=d-m,a.$undoCount.text(a.undoCount)}a.undoInfByStationRender()}var a=this;!function(){i.services({serviceCode:"GMES-CLIENT-KEYPART003",data:{serviceCode:"GMES-CLIENT-KEYPART003",siteCode:l.siteCode,productNum:a.$productmark.val().toUpperCase()},message:"正在获取扫描清单"}).done(function(e){a.tableAllDataFirst=e.data.first,i.rightCode(e,t)}).fail(function(){n.alert({type:"3",text:"解析失败！"}),a.$productmark.focus().select()})}(),e("#lotBarCodeInput").focus().select()},undoInfByStationRender:function(){var t=this;t.undoCountAll=t.undoCount,e(".ipCollectAdd-Query-site-allnum .stationNum").html(t.undoCountAll),t.undoCountAll<=0?e(".ipCollectAdd-Query-site-allnum").addClass("limegreen"):e(".ipCollectAdd-Query-site-allnum").removeClass("limegreen");var a=e("#ipCollectAdd-countInfSiteTpl").html(),o=Template7.compile(a),n=[];for(var r in t.undoInfByStation)t.undoInfByStation[r].undoCount=t.undoInfByStation[r].total-t.undoInfByStation[r].doneCount,t.undoInfByStation[r].undoCount<=0&&(t.undoInfByStation[r].extClass="limegreen"),n[t.undoInfByStation[r].stationIndex]=o(t.undoInfByStation[r]);var l=n.join("");e("#ipCollectAdd-querySiteRender").html(l)},undoInfByStationCheck:function(t,a){var o=this;o.undoCountAll-=a,e(".ipCollectAdd-Query-site-allnum .stationNum").html(o.undoCountAll),o.undoCountAll<=0?e(".ipCollectAdd-Query-site-allnum").addClass("limegreen"):e(".ipCollectAdd-Query-site-allnum").removeClass("limegreen"),o.undoInfByStation[t].doneCount+=a,o.undoInfByStation[t].undoCount-=a,e("[station="+t+"] span").html(o.undoInfByStation[t].undoCount),o.undoInfByStation[t].undoCount<=0?e("[station="+t+"]").addClass("limegreen"):e("[station="+t+"]").removeClass("limegreen")},lotBarCodeInputEvent:function(){function t(t){i.services({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART002",siteCode:l.siteCode,barcode:t.toUpperCase()},message:"请求中"}).done(function(t){i.rightCode(t,a)}).fail(function(){n.alert({type:"3",text:o.t("KEYPART.T.MSG_BATCH_NO_ERROR",{length:t.length})}),r.$lotBarCodeInput.focus().select()})}function a(t){var e,a=t.data,l=a.materialCode;if(r.alternateRelation[l]&&(e=r.alternateRelation[l].alternateForGroup,r.alternateRelation[e].count>=r.alternateRelation[e].maxCount))return n.alert({type:"3",text:o.t("KEYPART.T.MSG_NO_DATA_MATCH")}),void r.$lotBarCodeInput.focus().select();var i=r.table.row(function(t,e){return e.keypartCode===l&&1!=e.invalid&&1!=e.statusEcode&&2!=e.statusEcode}),u=r.table.row(function(t,e,a){return e.keypartCode===l&&(1==e.statusEcode||2==e.statusEcode)}),d=i.data(),s=u.data();if(d){d.supplierCode=a.supplierCode,d.lotNum=a.lotNum,d.supplierText=a.supplierText,a.valid?d.statusEcode=1:d.statusEcode=2;var c=i.index(),p=r.table.data().toArray();p.splice(c,1);var C=p.length>1?p[0]:void 0;!C||1!=C.statusEcode&&2!=C.statusEcode||(p.splice(0,1),p.push(C)),p.unshift(d),r.table.clear(),r.table.rows.add(p).draw(),n.alert({text:o.t("KEYPART.T.MSG_BATCH_NO_ANALYSE_SUCCESS")}),r.undoCount--;var f=d.stationCode;r.undoInfByStationCheck(f,1),r.stationOccupy?r.$undoCount.text(r.undoInfByStation[r.stationOccupy].undoCount):r.$undoCount.text(r.undoCount);var e;r.alternateRelation[f]&&r.alternateRelation[f][l]&&(e=r.alternateRelation[f][l].alternateForGroup),e&&++r.alternateRelation[f][e].count>=r.alternateRelation[f][e].maxCount&&(r.table.rows(function(t,a){return a.alternateGroup===e&&a.stationCode===f&&1!=a.statusEcode&&2!=a.statusEcode}).every(function(){this.data().invalid=!0}),r.table.draw()),r.$lotBarCodeInput.val("").focus()}else{var v=o.t("KEYPART.T.MSG_NO_DATA_MATCH");s&&(v="重复扫描！"),n.alert({type:"3",text:v}),r.$lotBarCodeInput.focus().select()}}var r=this,u=e("#lotBarCodeInput",r.page);u.keyup(function(a){var n=/[^\w\.\/]/gi;if(n.test(this.value)&&(this.value=this.value.replace(n,"")),13==a.keyCode){var r=u.val();r?(u.focus().select(),e("div.notify").remove(),t(r)):i.notify({type:"3",text:o.t("KEYPART.T.MSG_BATCH_NO_NOT_BE_NULL")},function(){u.focus()})}})},initData:function(){function t(t){var a={supplierLabel:o.t("KEYPART.T.SUPPLIER"),supplierList:t.data};i.tplManager("supplierListTpl",a,"supplierListRender");var r=n.supplierCode;r&&e("input[name='provider'][value="+r+"]").attr("checked",!0)}var a=this,n=a.selectRow.data();e("#supplierListRender",a.page).on("click",".content label",function(){e(".batch-input").focus()}),l.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART006",siteCode:l.siteCode,materialCode:n.keypartCode},success:function(e){i.rightCode(e,t)}})},headerEvent:function(){var t=this;e(".head-confirm").on("click",function(){!function(){function a(){myApp.showPreloader("数据保存中..."),l.request({url:"restful/service/execute",data:u,success:function(t){i.rightCode(t,r)},error:function(){myApp.hidePreloader(),n.alert({type:"3",text:o.t("COMMON.T.MSG_SAVE_DATA_FAILURE")})}})}function r(){myApp.hidePreloader(),i.notify({text:o.t("COMMON.T.MSG_SAVE_DATA_SUCCESS")}),t.removeSubmitEvent(),setTimeout(function(){e("div.notify").remove()},3e3),t.table.clear().draw(),t.$allCount.text(0),t.$undoCount.text(0),t.$lotBarCodeInput.val(""),t.$productmark.val("").focus(),e("#ipCollectAdd-querySiteRender").empty(),e(".stationNum").text("")}var u={serviceCode:"GMES-CLIENT-KEYPART015",siteCode:l.siteCode,productNum:t.$productmark.val().toUpperCase(),createUser:t.userCode,modifyUser:t.userCode,subAssemblyFlag:0},d=t.table.data(),s=d.length;if(s<=0)return n.alert({type:"3",text:o.t("KEYPART.T.MSG_NO_DATA_TO_SUBMIT")}),void t.$productmark.focus().select();for(var c=0;c<s;c++){var p=d[c];if(1==p.notNullFlag&&1!=p.invalid&&1!=p.statusEcode&&2!=p.statusEcode)return n.alert({type:"3",text:o.t("KEYPART.T.MSG_HAVE_NOT_NULL_DATA_SUBMIT",{keypartCode:p.keypartCode})}),void t.$lotBarCodeInput.focus().select();for(var C in p)if(p.hasOwnProperty(C)&&["createDate","createDateTime","modifyDate","modifyDateTime","invalid","hideFliterByStation"].indexOf(C)<0){var f="items["+c+"]."+C;"statusEcode"!=C||""!=p[C]&&null!=p[C]&&p[C]?u[f]=p[C]:u[f]=0}}t.undoCount>0?myApp.confirm("数据录入不完整，确定要提交？",function(){a()}):a()}()})},addSubmitEvent:function(){e(".head-confirm").css("background","#00adee"),this.headerEvent()},removeSubmitEvent:function(){e(".head-confirm").off(),e(".head-confirm").css("background","#CCC")},pickermodalclose:function(t){t&&document.querySelector(t)&&document.querySelector(t).focus()}};t.exports=u}).call(e,a(4),a(37),a(36))},666:function(t,e,a){"use strict";(function(e){var o=a(34),n=(sessionStorage.getItem("access_token"),e.baseEnv,{getLoginUser:function(t){return o.get("restful/user/getLoginUser",{},"",t)},getUserAllModuleMenus:function(t){}});t.exports=n}).call(e,a(29))}});
//# sourceMappingURL=pqs_ipCollectAdd_8b92981c0b5af20d64ef.js.map