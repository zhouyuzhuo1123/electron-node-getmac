{"version":3,"sources":["webpack:///assets/js/pages/pqs_ipCollect_26ebe36794fe5beb3a45.js","webpack:///./src/js/pages/pqs/ipCollect.js"],"names":["webpackJsonp","646","module","exports","__webpack_require__","app","$","i18next","notie","setOptions","station","context","options","data","keypartCode","supplierCode","lotNum","keypartText","supplierText","subAssemblyFlag","statusEcode","alternateGroup","quantity","relation","A0809","B0809","S0809","group","111","count","maxCount","222","emptyNormalFlag","lotBarCode","stationCode","stationText","params013","siteCode","params001","serviceCode","productNum","createUser","userCode","modifyUser","statusECode","dataTable","selectRow","$currentNum","$allNum","$productmark","$lotBarCodeInput","$ipCollectBatchNumber","undoCount","$table","dataTableConfig","serverSide","paging","searching","scrollY","page","height","order","ordering","dom","columns","render","type","row","t","rowCallback","children","addClass","invalid","_promise","_promise2","obj","__esModule","default","security","kit","util","getUserProfile","ipCollectCtrl","undefined","init","_this2","this","translate","isUniqueOperableStation","DataTable","service","done","response","rightCode","setBreadcrumb","event","force","text","buttonText","callback","returnHome","focus","on","saveEvent","tableEvent","productmarkEvent","lotBarCodeInputEvent","confirmEvent","deleteEvent","_this","target","hasClass","setInputVal","selectDefaultVendor","then","myApp","popup","val","setStatusEcode","resolve","status","materialCode","getCountChange","statusEcodeNew","statusEcodeOld","flag","parseInt","parents","rowData","saveToTable","_this3","toUpperCase","next","closeModal","sortData","afterEditSelectRowData","dataTableArr","rowIndex","index","splice","length","tableDataFirst","shift","push","unshift","clear","rows","add","parent","scrollTop","setInvalid","selectRowData","countChange","every","_this4","draw","emptySaveAajx","request","url","success","returnCode","alert","errorMessage","select","emptySave","modal","title","buttons","onClick","bold","disabledInput","selector","disabled","attr","getListDataFromServer","_this5","createTable","fail","emptyList","first","fullList","arr","j","extend","removeNull","renderCount","keypartCount","validCount","firstCollect","_this6","list","forEach","item","concat","continueCollect","_this7","key","idx","removeClass","loadTableByProductNum","rsCode","keyup","value","filter","keyCode","remove","code","barcode","dealKeypartCode","returnData","rowSelectMatch","seleceRowData","rowMatchData","valid","contentMsg","renderData","supplierLabel","supplierList","tplManager","fromSupplierCode","param","tableData","dataLength","i","tableDataI","notNullFlag","hasOwnProperty","indexOf","keyNew","confirm","submitConfirm","saveDataSuccess","hidePreloader","_this8","removeAttr","call"],"mappings":"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","file":"assets/js/pages/pqs_ipCollect_26ebe36794fe5beb3a45.js","sourcesContent":["webpackJsonp([16],{\n\n/***/ 646:\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n/* WEBPACK VAR INJECTION */(function(app, $, i18next, notie) {\n\nvar _promise = __webpack_require__(113);\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar security = __webpack_require__(35);\nvar kit = __webpack_require__(78);\nvar util = __webpack_require__(34);\nvar userCode = security.getUserProfile().userCode;\n\nvar options;\n\nfunction setOptions(station, context) {\n\toptions = {\n\t\tdata: {\n\t\t\tkeypartCode: \"\",\n\t\t\tsupplierCode: \"\",\n\t\t\tlotNum: \"\",\n\t\t\tkeypartText: \"\",\n\t\t\tsupplierText: \"\",\n\t\t\tsubAssemblyFlag: \"\",\n\t\t\tstatusEcode: \"\",\n\t\t\talternateGroup: \"\",\n\t\t\tquantity: \"\" },\n\n\t\trelation: {\n\t\t\tA0809: { alternateGroup: \"111\" },\n\t\t\tB0809: { alternateGroup: \"222\" },\n\t\t\tS0809: { alternateGroup: \"111\" }\n\t\t},\n\t\tgroup: {\n\t\t\t111: {\n\t\t\t\tcount: 0,\n\t\t\t\tmaxCount: \"3\" },\n\t\t\t222: {\n\t\t\t\tcount: 0,\n\t\t\t\tmaxCount: \"2\"\n\t\t\t}\n\t\t},\n\t\temptyNormalFlag: \"\",\n\t\tlotBarCode: \"\",\n\t\tstation: station || {\n\t\t\tstationCode: \"\",\n\t\t\tstationText: \"\" },\n\n\t\tparams013: {\n\t\t\tsiteCode: app.siteCode,\n\t\t\tstationCode: station.stationCode\n\t\t},\n\t\tparams001: {\n\t\t\tserviceCode: \"GMES-CLIENT-KEYPART001\",\n\t\t\tsiteCode: app.siteCode,\n\t\t\tstationCode: station.stationCode,\n\t\t\tproductNum: \"\",\n\t\t\tcreateUser: userCode,\n\t\t\tmodifyUser: userCode,\n\t\t\tsubAssemblyFlag: 0,\n\t\t\tstatusECode: \"\"\n\t\t},\n\t\tdataTable: null,\n\t\tselectRow: null,\n\t\t$currentNum: $(\"#currentNum\"),\n\t\t$allNum: $(\"#allNum\"),\n\t\t$productmark: $(\"#productmark\"),\n\t\t$lotBarCodeInput: $(\"#lotBarCodeInput\"),\n\t\t$ipCollectBatchNumber: $(\"#ipCollect-batchNumber\"),\n\t\tuserCode: userCode,\n\t\tundoCount: 0,\n\t\t$table: $(\".ipCollect .table-panel table\"),\n\n\t\tdataTableConfig: {\n\t\t\tserverSide: false,\n\t\t\tpaging: false,\n\t\t\tsearching: false,\n\t\t\tscrollY: context.page.height - 158 - 30,\n\t\t\torder: [],\n\t\t\tordering: false,\n\t\t\tdata: [],\n\t\t\tdom: \"<'row'<'col-50'f>> <'row'<'col-100'tr>> <'row'<'col-50'p>>\",\n\t\t\tcolumns: [{\n\t\t\t\tdata: \"keypartCode\",\n\t\t\t\trender: function render(data, type, row) {\n\t\t\t\t\treturn \"<span class='ipCollect-component-value'>\" + row.keypartCode + \"</span>\";\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\tdata: \"supplierCode\",\n\t\t\t\trender: function render(data, type, row) {\n\t\t\t\t\treturn \"<a class='f-cp ipCollect-open-picker-supplier-value ipCollect-open-picker'>\" + row.supplierCode + \"</a>\";\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\tdata: \"lotNum\",\n\t\t\t\trender: function render(data, type, row) {\n\t\t\t\t\treturn \"<a class='f-cp ipCollect-open-picker-batch-value  ipCollect-open-picker'>\" + row.lotNum + \"</a>\";\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\tdata: \"keypartText\"\n\t\t\t}, {\n\t\t\t\tdata: \"supplierText\"\n\t\t\t}, {\n\t\t\t\trender: function render() {\n\t\t\t\t\treturn \"<button class='cancel'>\" + i18next.t(\"KEYPART.B.REPEAL\") + \"</button>\";\n\t\t\t\t}\n\t\t\t}],\n\n\t\t\trowCallback: function rowCallback(row, data) {\n\t\t\t\tif (data.statusEcode == 2) {\n\t\t\t\t\t$(row).children().addClass('error');\n\t\t\t\t\t$(row).children('td').children('button').addClass('delBtn');\n\t\t\t\t}\n\n\t\t\t\tif (data.invalid === true) {\n\t\t\t\t\t$(row).addClass(\"invalid\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}\n\nvar ipCollectCtrl = {\n\tpage: undefined,\n\tinit: function init() {\n\t\tvar _this2 = this;\n\n\t\tutil.translate(this.page);\n\t\tsecurity.isUniqueOperableStation(function (station) {\n\t\t\tsetOptions(station, _this2);\n\n\t\t\toptions.dataTable = options.$table.DataTable(options.dataTableConfig);\n\n\t\t\tutil.service(\"GMES-CLIENT-KEYPART013\", options.params013).done(function (response) {\n\t\t\t\tutil.rightCode(response, function (response) {\n\t\t\t\t\tif (response.data === true) {\n\t\t\t\t\t\tutil.setBreadcrumb([i18next.t(\"KEYPART.T.MENU_COLLECT\") + \" \" + options.station.stationCode]);\n\n\t\t\t\t\t\t_this2.event();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnotie.force({\n\t\t\t\t\t\t\ttype: 3,\n\t\t\t\t\t\t\ttext: i18next.t(\"COMMON.T.MSG_INVALID_PERMISSIONS\"),\n\t\t\t\t\t\t\tbuttonText: '知道了',\n\t\t\t\t\t\t\tcallback: function callback() {\n\t\t\t\t\t\t\t\tutil.returnHome();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t},\n\n\tevent: function event() {\n\t\t$(\"#productmark\").focus();\n\n\t\t$('.close-picker').on('click', function () {\n\t\t\t$('#lotBarCodeInput').focus();\n\t\t});\n\n\t\tthis.saveEvent();\n\t\tthis.tableEvent();\n\t\tthis.productmarkEvent();\n\t\tthis.lotBarCodeInputEvent();\n\t\tthis.confirmEvent();\n\t\tthis.deleteEvent();\n\t},\n\n\ttableEvent: function tableEvent() {\n\t\tvar _this = this;\n\t\t$(\".table-panel tbody\").on(\"click\", \"tr:not(.invalid)\", function (event) {\n\t\t\tif ($(event.target).hasClass(\"dataTables_empty\") || $(event.target).hasClass(\"cancel\")) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\toptions.selectRow = options.dataTable.row(this);\n\t\t\t_this.setInputVal();\n\t\t\t_this.selectDefaultVendor().then(function () {\n\t\t\t\tmyApp.popup('.picker-modal');\n\t\t\t});\n\t\t});\n\t},\n\tsetInputVal: function setInputVal() {\n\t\tvar data = options.selectRow.data();\n\t\t$(\"#ipCollect-component\").val(data[\"keypartCode\"]);\n\t\t$(\"#ipCollect-batchNumber\").val(data[\"lotNum\"]);\n\t},\n\n\tsetStatusEcode: function setStatusEcode(supplierCode, lotNum, subAssemblyFlag) {\n\n\t\treturn new _promise2.default(function (resolve) {\n\t\t\tvar status = 2;\n\t\t\tif (supplierCode === \"\" && lotNum === \"\") {\n\t\t\t\tstatus = 0;\n\t\t\t\tresolve(status);\n\t\t\t} else if (supplierCode !== \"\" && lotNum !== \"\") {\n\t\t\t\tif (subAssemblyFlag == 1) {\n\t\t\t\t\tstatus = 1;\n\t\t\t\t\tresolve(status);\n\t\t\t\t} else if (subAssemblyFlag != 1) {\n\n\t\t\t\t\tutil.service(\"GMES-CLIENT-KEYPART011\", {\n\t\t\t\t\t\tsiteCode: app.siteCode,\n\t\t\t\t\t\tmaterialCode: options.selectRow.data().keypartCode,\n\t\t\t\t\t\tsupplierCode: supplierCode\n\t\t\t\t\t}, \"正在检验物料供应商关系\").done(function (response) {\n\t\t\t\t\t\tutil.rightCode(response, function (response) {\n\t\t\t\t\t\t\tif (response.data === true) {\n\t\t\t\t\t\t\t\tstatus = 1;\n\t\t\t\t\t\t\t\tresolve(status);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tresolve(status);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresolve(status);\n\t\t\t}\n\t\t});\n\t},\n\n\tgetCountChange: function getCountChange(statusEcodeNew, statusEcodeOld) {\n\t\tvar count = 0;\n\t\tvar flag;\n\n\t\tstatusEcodeOld = parseInt(statusEcodeOld);\n\t\tflag = statusEcodeOld === 0 || !statusEcodeOld;\n\n\t\tif (flag && statusEcodeNew !== 0) {\n\t\t\tcount = -1;\n\t\t} else if (statusEcodeOld > 0 && statusEcodeNew === 0) {\n\t\t\tcount = +1;\n\t\t}\n\n\t\toptions.undoCount += count;\n\t\toptions.$currentNum.text(options.undoCount);\n\n\t\treturn count;\n\t},\n\tdeleteEvent: function deleteEvent() {\n\t\tvar _this = this;\n\t\t$(\".table-panel tbody\").on(\"click\", \".cancel\", function () {\n\n\t\t\toptions.selectRow = options.dataTable.row($(this).parents(\"tr\"));\n\t\t\tvar rowData = options.selectRow.data();\n\n\t\t\tif (rowData.supplierCode || rowData.lotNum || rowData.supplierText) {\n\t\t\t\trowData.supplierCode = rowData.lotNum = rowData.supplierText = \"\";\n\n\t\t\t\t_this.saveToTable(rowData);\n\t\t\t}\n\t\t});\n\t},\n\tconfirmEvent: function confirmEvent() {\n\t\tvar _this3 = this;\n\n\t\t$(\".ipCollect\").on('click', \".ipCollect-confirm\", function () {\n\n\t\t\tvar rowData = options.selectRow.data();\n\n\t\t\trowData.supplierCode = $('input:radio[name=\"provider\"]:checked').val() || \"\";\n\t\t\trowData.lotNum = $(\"#ipCollect-batchNumber\").val().toUpperCase() || \"\";\n\t\t\trowData.supplierText = $('input:radio[name=\"provider\"]:checked').next().children('span').text() || \"\";\n\n\t\t\t_this3.saveToTable(rowData);\n\t\t\tmyApp.closeModal('.picker-info');\n\t\t});\n\t},\n\n\tsortData: function sortData(afterEditSelectRowData) {\n\t\tvar dataTableArr = options.dataTable.data();\n\t\tvar rowIndex = options.selectRow.index();\n\t\tdataTableArr.splice(rowIndex, 1);\n\n\t\tif (dataTableArr.length > 1) {\n\t\t\tvar tableDataFirst = dataTableArr[0];\n\n\t\t\tif (tableDataFirst.statusEcode == 1 || tableDataFirst.statusEcode == 2) {\n\t\t\t\tdataTableArr.shift();\n\t\t\t\tdataTableArr.push(tableDataFirst);\n\t\t\t}\n\t\t}\n\n\t\tdataTableArr.unshift(afterEditSelectRowData);\n\n\t\toptions.dataTable.clear();\n\t\toptions.dataTable.rows.add(dataTableArr);\n\t\toptions.$table.parent().scrollTop(0);\n\n\t\treturn dataTableArr;\n\t},\n\tsetInvalid: function setInvalid(selectRowData, countChange) {\n\t\tvar keypartCode = selectRowData.keypartCode;\n\t\tif (options.relation[keypartCode]) {\n\n\t\t\tvar flag = false;\n\t\t\tvar alternateGroup = options.relation[keypartCode].alternateGroup;\n\n\t\t\toptions.group[alternateGroup].count -= countChange;\n\n\t\t\tif (options.group[alternateGroup].count >= options.group[alternateGroup].maxCount) {\n\t\t\t\tflag = true;\n\t\t\t}\n\n\t\t\toptions.dataTable.rows(function (index, data) {\n\t\t\t\tvar flag = data.alternateGroup === alternateGroup && data.statusEcode != 1 && data.statusEcode != 2;\n\t\t\t\treturn flag;\n\t\t\t}).every(function () {\n\t\t\t\tvar data = this.data();\n\t\t\t\tdata.invalid = flag;\n\t\t\t});\n\t\t}\n\t},\n\n\tsaveToTable: function saveToTable(selectRowData) {\n\t\tvar _this4 = this;\n\n\t\tthis.setStatusEcode(selectRowData.supplierCode, selectRowData.lotNum, selectRowData.subAssemblyFlag).then(function (statusEcodeNew) {\n\t\t\tvar countChange = _this4.getCountChange(statusEcodeNew, selectRowData.statusEcode);\n\n\t\t\tselectRowData.statusEcode = statusEcodeNew;\n\t\t\t_this4.sortData(selectRowData);\n\n\t\t\t_this4.setInvalid(selectRowData, countChange);\n\n\t\t\toptions.dataTable.draw();\n\t\t});\n\t},\n\n\temptySaveAajx: function emptySaveAajx() {\n\n\t\toptions.params001.productNum = options.$productmark.val().toUpperCase();\n\t\toptions.params001.statusECode = options.emptyNormalFlag;\n\n\t\tapp.request({\n\t\t\turl: \"restful/service/execute\",\n\t\t\tdata: options.params001,\n\t\t\tsuccess: function success(response) {\n\t\t\t\tif (response.returnCode === \"0\") {\n\t\t\t\t\tnotie.alert({ type: \"1\", text: \"标记成功！\" });\n\t\t\t\t} else {\n\t\t\t\t\tnotie.alert({ text: response.errorMessage });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\toptions.$productmark.focus().select();\n\t},\n\temptySave: function emptySave() {\n\t\tvar _this = this;\n\t\tmyApp.modal({\n\t\t\ttitle: 'iME提示',\n\t\t\ttext: '清单为空，跳过请标记',\n\t\t\tbuttons: [{\n\t\t\t\ttext: '异常',\n\t\t\t\tonClick: function onClick() {\n\t\t\t\t\toptions.emptyNormalFlag = \"30\";\n\t\t\t\t\t_this.emptySaveAajx();\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\ttext: '正常',\n\t\t\t\tbold: true,\n\t\t\t\tonClick: function onClick() {\n\t\t\t\t\toptions.emptyNormalFlag = \"20\";\n\t\t\t\t\t_this.emptySaveAajx();\n\t\t\t\t}\n\t\t\t}]\n\t\t});\n\t},\n\tdisabledInput: function disabledInput(selector, disabled) {\n\t\tselector.attr('disabled', disabled);\n\t},\n\n\tgetListDataFromServer: function getListDataFromServer() {\n\t\tvar _this5 = this;\n\n\t\tutil.service('GMES-CLIENT-KEYPART003', {\n\t\t\tsiteCode: app.siteCode,\n\t\t\tstationCode: options.station.stationCode,\n\t\t\tproductNum: options.$productmark.val().toUpperCase()\n\t\t}, \"正在获取扫描清单\").done(function (response) {\n\t\t\tutil.rightCode(response, _this5.createTable, _this5);\n\t\t}).fail(function () {\n\t\t\toptions.$productmark.focus().select();\n\t\t});\n\t},\n\n\temptyList: function emptyList(first) {\n\t\tif (first) {\n\t\t\tthis.emptySave();\n\t\t} else {\n\t\t\tnotie.alert({ text: i18next.t(\"KEYPART.T.MSG_RECORDLIST_IS_EMPTY\") });\n\t\t\toptions.dataTable.clear().draw();\n\t\t\toptions.$productmark.focus().select();\n\t\t}\n\t},\n\tfullList: function fullList(data) {\n\t\tvar quantity = data.quantity;\n\t\tvar arr = [];\n\t\tfor (var j = 0; j < quantity; j++) {\n\t\t\tdata.lotNum = \"\";\n\t\t\tdata.supplierCode = \"\";\n\t\t\tarr.push($.extend(true, {}, data));\n\t\t}\n\t\treturn arr;\n\t},\n\tremoveNull: function removeNull(data) {\n\t\tif (!data.lotNum) {\n\t\t\tdata.lotNum = \"\";\n\t\t}\n\n\t\tif (!data.supplierCode) {\n\t\t\tdata.supplierCode = \"\";\n\t\t}\n\n\t\treturn data;\n\t},\n\n\trenderCount: function renderCount(keypartCount, validCount) {\n\t\toptions.$allNum.text(keypartCount);\n\t\toptions.undoCount = keypartCount - (validCount || 0);\n\t\toptions.$currentNum.text(options.undoCount);\n\t},\n\n\tfirstCollect: function firstCollect(data) {\n\t\tvar _this6 = this;\n\n\t\tvar keypartCount = 0;\n\t\tvar list = [];\n\t\tvar relation = options.relation = {};\n\t\toptions.group = {};\n\n\t\tkit.forEach(data, function (item) {\n\n\t\t\tvar quantity = item.quantity;\n\t\t\tvar alternateGroup = item.alternateGroup;\n\t\t\tvar keypartCode = item.keypartCode;\n\t\t\tlist = list.concat(_this6.fullList(item));\n\n\t\t\tif (alternateGroup) {\n\t\t\t\trelation[keypartCode] = {\n\t\t\t\t\talternateGroup: alternateGroup\n\t\t\t\t};\n\n\t\t\t\tif (options.group[alternateGroup]) {\n\t\t\t\t\tif (quantity > options.group[alternateGroup].maxCount) {\n\t\t\t\t\t\toptions.group[alternateGroup].maxCount = quantity;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\toptions.group[alternateGroup] = {\n\t\t\t\t\t\tcount: 0,\n\t\t\t\t\t\tmaxCount: quantity\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tkeypartCount += parseInt(quantity);\n\t\t\t}\n\t\t});\n\n\t\tkit.forEach(options.group, function (item) {\n\t\t\tkeypartCount += parseInt(item.maxCount);\n\t\t});\n\n\t\tthis.renderCount(keypartCount);\n\n\t\treturn list;\n\t},\n\tcontinueCollect: function continueCollect(data) {\n\t\tvar _this7 = this;\n\n\t\tvar keypartCount = 0;\n\t\tvar validCount = 0;\n\t\tvar relation = options.relation = {};\n\t\toptions.group = {};\n\n\t\tkit.forEach(data, function (item) {\n\n\t\t\tvar alternateGroup = item.alternateGroup;\n\t\t\tvar keypartCode = item.keypartCode;\n\t\t\tif (item.statusEcode == 1 || item.statusEcode == 2) {\n\t\t\t\tvalidCount++;\n\t\t\t}\n\n\t\t\titem = _this7.removeNull(item);\n\n\t\t\tif (alternateGroup) {\n\n\t\t\t\tif (relation[keypartCode]) {\n\t\t\t\t\trelation[keypartCode].maxCount += 1;\n\t\t\t\t} else {\n\t\t\t\t\trelation[keypartCode] = {\n\t\t\t\t\t\tmaxCount: 1,\n\t\t\t\t\t\talternateGroup: alternateGroup\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tif (!options.group[alternateGroup]) {\n\t\t\t\t\toptions.group[alternateGroup] = {\n\t\t\t\t\t\tmaxCount: 0,\n\t\t\t\t\t\tcount: 0\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tif (item.statusEcode == 1 || item.statusEcode == 2) {\n\t\t\t\t\toptions.group[alternateGroup].count++;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tkeypartCount++;\n\t\t\t}\n\t\t});\n\n\t\tkit.forEach(relation, function (item) {\n\t\t\tvar alternateGroup = item.alternateGroup;\n\t\t\tif (item.maxCount > options.group[alternateGroup].maxCount) {\n\t\t\t\toptions.group[alternateGroup].maxCount = item.maxCount;\n\t\t\t}\n\t\t});\n\n\t\tkit.forEach(options.group, function (item, key) {\n\t\t\tkeypartCount += item.maxCount;\n\n\t\t\tif (item.count >= item.maxCount) {\n\n\t\t\t\toptions.dataTable.rows(function (idx, data) {\n\t\t\t\t\treturn data.alternateGroup === key && data.statusEcode != 1 && data.statusEcode != 2;\n\t\t\t\t}).every(function () {\n\t\t\t\t\tvar data = this.data();\n\t\t\t\t\tdata.invalid = true;\n\t\t\t\t});\n\t\t\t\toptions.dataTable.draw();\n\t\t\t}\n\t\t});\n\n\t\tthis.renderCount(keypartCount, validCount);\n\n\t\treturn data;\n\t},\n\tcreateTable: function createTable(response) {\n\n\t\tvar data = response.data.list;\n\t\tvar length = data.length;\n\t\tvar first = response.data.first;\n\n\t\tif (length <= 0) {\n\t\t\tthis.emptyList(first);\n\t\t\treturn;\n\t\t}\n\n\t\tif (first) {\n\t\t\tdata = this.firstCollect(data);\n\t\t\toptions.dataTable.clear();\n\t\t\toptions.dataTable.rows.add(data).draw();\n\t\t\toptions.$lotBarCodeInput.focus();\n\t\t} else {\n\t\t\tdata = this.continueCollect(data);\n\t\t\toptions.dataTable.clear();\n\t\t\toptions.dataTable.rows.add(data).draw();\n\t\t}\n\n\t\t$('.head-confirm').removeClass(\"disabled\");\n\t},\n\tloadTableByProductNum: function loadTableByProductNum() {\n\t\tvar _this = this;\n\n\t\tutil.service(\"GMES-CLIENT-KEYPART018\", {\n\t\t\tsiteCode: app.siteCode,\n\t\t\tstationCode: options.station.stationCode,\n\t\t\tproductNum: options.$productmark.val().toUpperCase()\n\t\t}, \"VIN号校验中\").done(function (response) {\n\n\t\t\tutil.rightCode(response, function (response) {\n\t\t\t\tvar rsCode = response.data;\n\n\t\t\t\tif (rsCode === \"1\") {\n\t\t\t\t\t_this.disabledInput(options.$productmark, 'disabled');\n\t\t\t\t\t_this.getListDataFromServer();\n\t\t\t\t} else if (rsCode === \"2\") {\n\t\t\t\t\tnotie.alert({ type: 2, text: \"产品标识号不连续\" });\n\t\t\t\t\t_this.disabledInput(options.$productmark, 'disabled');\n\t\t\t\t\t_this.getListDataFromServer();\n\t\t\t\t} else {\n\t\t\t\t\t$('.head-confirm').addClass(\"disabled\");\n\t\t\t\t\tnotie.alert({ text: \"无效的产品标识号\" });\n\t\t\t\t\toptions.$productmark.focus().select();\n\t\t\t\t}\n\t\t\t});\n\t\t}).fail(function () {\n\t\t\toptions.$productmark.focus().select();\n\t\t});\n\n\t\t$('#lotBarCodeInput').focus().select();\n\t},\n\tproductmarkEvent: function productmarkEvent() {\n\t\tvar _this = this;\n\t\tvar $productmark = options.$productmark;\n\t\t$productmark.keyup(function (event) {\n\n\t\t\tthis.value = util.filter(this.value);\n\n\t\t\tif (event.keyCode == 13 && this.value !== \"\") {\n\t\t\t\t$productmark.focus().select();\n\t\t\t\t$(\"div.productmark\").remove();\n\t\t\t\t_this.loadTableByProductNum();\n\t\t\t}\n\t\t});\n\n\t\toptions.$ipCollectBatchNumber.keyup(function () {\n\t\t\tthis.value = util.filter(this.value);\n\t\t});\n\t},\n\tlotBarCodeInputEvent: function lotBarCodeInputEvent() {\n\t\tvar $lotBarCodeInput = options.$lotBarCodeInput;\n\t\tvar _this = this;\n\t\t$lotBarCodeInput.keyup(function (event) {\n\n\t\t\tthis.value = util.filter(this.value);\n\t\t\tvar code = this.value;\n\t\t\tif (event.keyCode == 13 && code) {\n\t\t\t\t$lotBarCodeInput.focus().select();\n\n\t\t\t\tutil.service('GMES-CLIENT-KEYPART002', {\n\t\t\t\t\tsiteCode: app.siteCode,\n\t\t\t\t\tbarcode: code.toUpperCase()\n\t\t\t\t}).done(function (response) {\n\t\t\t\t\tutil.rightCode(response, function (response) {\n\t\t\t\t\t\t_this.dealKeypartCode(response);\n\t\t\t\t\t});\n\t\t\t\t}).fail(function () {\n\t\t\t\t\tnotie.alert({\n\t\t\t\t\t\ttext: \"批次条码没有当前长度规则，可通过后台配置\" });\n\t\t\t\t\toptions.$lotBarCodeInput.focus().select();\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\tdealKeypartCode: function dealKeypartCode(response) {\n\t\tvar returnData = response.data;\n\t\tvar materialCode = returnData.materialCode;\n\n\t\tvar keypartCode;\n\t\tif (options.relation[materialCode]) {\n\t\t\tkeypartCode = options.relation[materialCode].alternateGroup;\n\t\t\tif (options.relation[keypartCode].count >= options.relation[keypartCode].maxCount) {\n\t\t\t\tnotie.alert({ text: \"组件数量已满！\" });\n\t\t\t\toptions.$lotBarCodeInput.focus().select();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\toptions.selectRow = options.dataTable.row(function (idx, data) {\n\t\t\treturn data.materialCode === materialCode && data.invalid !== true && data.statusEcode != 1 && data.statusEcode != 2;\n\t\t});\n\n\t\tvar rowSelectMatch = options.dataTable.row(function (idx, data) {\n\t\t\treturn data.materialCode === materialCode && (data.statusEcode == 1 || data.statusEcode == 2);\n\t\t});\n\n\t\tvar seleceRowData = options.selectRow.data();\n\t\tvar rowMatchData = rowSelectMatch.data();\n\n\t\tif (seleceRowData) {\n\t\t\tseleceRowData.supplierCode = returnData.supplierCode;\n\t\t\tseleceRowData.lotNum = returnData.lotNum;\n\t\t\tseleceRowData.supplierText = returnData.supplierText;\n\n\t\t\tif (returnData.valid) {\n\t\t\t\tseleceRowData.statusEcode = 1;\n\t\t\t} else {\n\t\t\t\tseleceRowData.statusEcode = 2;\n\t\t\t}\n\n\t\t\tthis.sortData(seleceRowData);\n\n\t\t\toptions.dataTable.draw();\n\n\t\t\tnotie.alert({ text: i18next.t(\"KEYPART.T.MSG_BATCH_NO_ANALYSE_SUCCESS\") });\n\n\t\t\toptions.undoCount--;\n\t\t\toptions.$currentNum.text(options.undoCount);\n\n\t\t\tif (keypartCode) {\n\t\t\t\toptions.relation[keypartCode].count++;\n\t\t\t\tif (options.relation[keypartCode].count >= options.relation[keypartCode].maxCount) {\n\t\t\t\t\toptions.dataTable.rows(function (idx, data) {\n\t\t\t\t\t\treturn data.alternateGroup === keypartCode && data.statusEcode != 1 && data.statusEcode != 2 ? true : false;\n\t\t\t\t\t}).every(function () {\n\t\t\t\t\t\tvar data = this.data();\n\t\t\t\t\t\tdata.invalid = true;\n\t\t\t\t\t});\n\t\t\t\t\toptions.dataTable.draw();\n\t\t\t\t}\n\t\t\t}\n\t\t\toptions.$lotBarCodeInput.val(\"\").focus();\n\t\t} else {\n\t\t\tvar contentMsg = \"无匹配数据！\";\n\t\t\tif (rowMatchData) {\n\t\t\t\tcontentMsg = \"重复扫描！\";\n\t\t\t}\n\t\t\tnotie.alert({ text: contentMsg });\n\t\t\toptions.$lotBarCodeInput.focus().select();\n\t\t}\n\t},\n\tselectDefaultVendor: function selectDefaultVendor() {\n\t\tvar rowData = options.selectRow.data();\n\n\t\treturn util.service(\"GMES-CLIENT-KEYPART006\", {\n\t\t\tserviceCode: \"GMES-CLIENT-KEYPART006\",\n\t\t\tsiteCode: app.siteCode,\n\t\t\tmaterialCode: rowData.keypartCode\n\t\t}, \"正在获取默认供应商数据\").done(function (response) {\n\t\t\tutil.rightCode(response, function (response) {\n\n\t\t\t\tvar renderData = {\n\t\t\t\t\tsupplierLabel: i18next.t(\"KEYPART.T.SUPPLIER\"),\n\t\t\t\t\tsupplierList: response.data\n\t\t\t\t};\n\n\t\t\t\tutil.tplManager(\"supplierListTpl\", renderData, \"supplierListRender\");\n\n\t\t\t\tvar fromSupplierCode = rowData.supplierCode;\n\t\t\t\tif (fromSupplierCode) {\n\t\t\t\t\t$(\"input[name='provider'][value=\" + fromSupplierCode + \"]\").attr(\"checked\", true);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n\tsaveEvent: function saveEvent() {\n\t\tvar _this = this;\n\t\t$('.head-confirm').on('click', function () {\n\t\t\tvar param = {\n\t\t\t\tsiteCode: app.siteCode,\n\t\t\t\tstationCode: options.station.stationCode,\n\t\t\t\tproductNum: options.$productmark.val().toUpperCase(),\n\t\t\t\tcreateUser: options.userCode,\n\t\t\t\tmodifyUser: options.userCode,\n\t\t\t\tsubAssemblyFlag: 0,\n\t\t\t\tstatusECode: \"10\"\n\t\t\t};\n\t\t\tvar tableData = options.dataTable.data();\n\t\t\tvar dataLength = tableData.length;\n\n\t\t\tif (dataLength <= 0) {\n\t\t\t\tnotie.alert({ text: \"无提交数据！\" });\n\t\t\t\toptions.$productmark.val(\"\").focus();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfor (var i = 0; i < dataLength; i++) {\n\t\t\t\tvar tableDataI = tableData[i];\n\n\t\t\t\tif (tableDataI.notNullFlag == 1 && tableDataI.invalid !== true && tableDataI.statusEcode != 1 && tableDataI.statusEcode != 2) {\n\t\t\t\t\tnotie.alert({\n\t\t\t\t\t\ttext: i18next.t(\"KEYPART.T.MSG_HAVE_NOT_NULL_DATA_SUBMIT\", {\n\t\t\t\t\t\t\tkeypartCode: tableDataI.keypartCode\n\t\t\t\t\t\t})\n\t\t\t\t\t});\n\t\t\t\t\toptions.$lotBarCodeInput.focus().select();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tfor (var key in tableDataI) {\n\t\t\t\t\tif (tableDataI.hasOwnProperty(key)) {\n\t\t\t\t\t\tif ([\"createDate\", \"createDateTime\", \"modifyDate\", \"modifyDateTime\", \"invalid\"].indexOf(key) < 0) {\n\t\t\t\t\t\t\tvar keyNew = \"items[\" + i + \"].\" + key;\n\t\t\t\t\t\t\tif (key == \"statusEcode\" && (tableDataI[key] == \"\" || tableDataI[key] === null || !tableDataI[key])) {\n\t\t\t\t\t\t\t\tparam[keyNew] = 0;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tparam[keyNew] = tableDataI[key];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (options.undoCount > 0) {\n\t\t\t\tmyApp.confirm('数据录入不完整，确定要提交？', function () {\n\t\t\t\t\t_this.submitConfirm(param);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t_this.submitConfirm(param);\n\t\t\t}\n\t\t});\n\t},\n\tsaveDataSuccess: function saveDataSuccess() {\n\t\tmyApp.hidePreloader();\n\t\tnotie.alert({ text: \"保存数据成功\" });\n\n\t\tthis.disabledInput(options.$productmark, false);\n\t\toptions.dataTable.clear().draw();\n\t\toptions.$allNum.text(0);\n\t\toptions.$currentNum.text(0);\n\t\toptions.$lotBarCodeInput.val(\"\");\n\t\toptions.$productmark.val(\"\").focus();\n\t},\n\tsubmitConfirm: function submitConfirm(param) {\n\t\tvar _this8 = this;\n\n\t\tutil.service(\"GMES-CLIENT-KEYPART001\", param, \"数据保存中...\").done(function (response) {\n\t\t\tutil.rightCode(response, function () {\n\t\t\t\t_this8.saveDataSuccess();\n\t\t\t});\n\t\t}).fail(function () {\n\t\t\tmyApp.modal({\n\t\t\t\ttitle: 'iME',\n\t\t\t\ttext: '数据保存失败，选择操作',\n\t\t\t\tbuttons: [{\n\t\t\t\t\ttext: '扫下一个',\n\t\t\t\t\tonClick: function onClick() {\n\t\t\t\t\t\toptions.dataTable.clear().draw();\n\t\t\t\t\t\toptions.$allNum.text(0);\n\t\t\t\t\t\toptions.$currentNum.text(0);\n\t\t\t\t\t\toptions.$lotBarCodeInput.val(\"\");\n\n\t\t\t\t\t\toptions.$productmark.removeAttr(\"disabled\").val(\"\").focus();\n\t\t\t\t\t}\n\t\t\t\t}, {\n\t\t\t\t\ttext: '继续修改',\n\t\t\t\t\tbold: true,\n\t\t\t\t\tonClick: function onClick() {\n\t\t\t\t\t\toptions.$lotBarCodeInput.focus().select();\n\t\t\t\t\t}\n\t\t\t\t}]\n\t\t\t});\n\t\t});\n\t}\n};\n\nmodule.exports = ipCollectCtrl;\n/* WEBPACK VAR INJECTION */}.call(exports, __webpack_require__(77), __webpack_require__(4), __webpack_require__(37), __webpack_require__(36)))\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// assets/js/pages/pqs_ipCollect_26ebe36794fe5beb3a45.js","/*\r\n * @name: \\pcs\\ipCollect.js\r\n * @url: http://git.evun.cn/GMES/GMES_CLIENT_PAD\r\n * @author: EVUN前端组\r\n * @modify: kelichao\r\n * @update: 2017-06-13\r\n * @decript: 关重件采集 LB37724SXHX680029\r\n */\r\n\r\nvar security = require(\"security\");\r\nvar kit = require(\"kit\");\r\nvar util = require(\"util\");\r\nvar userCode = security.getUserProfile().userCode;\r\n\r\nvar options;\r\n\r\nfunction setOptions(station, context) {\r\n\toptions = {\r\n\t\t// 行数据初始化\r\n\t\tdata: {\r\n\t\t\tkeypartCode: \"\",// 物料编码\r\n\t\t\tsupplierCode: \"\",// 供应商\r\n\t\t\tlotNum: \"\",// 批次\r\n\t\t\tkeypartText: \"\",//物料描述\r\n\t\t\tsupplierText: \"\",// 供应商描述\r\n\t\t\tsubAssemblyFlag: \"\",// 分装标识  1.不需要验证 0.需要验证\r\n\t\t\tstatusEcode: \"\",// 0.未采  1.供应商和批次条码都全  2.供应商和批次条码有一个为空\r\n\t\t\talternateGroup: \"\",// 属于哪个关重件替代组 \"111\" \"222\"\r\n\t\t\tquantity: \"\"// 该组的数量\r\n\t\t},\r\n\t\t// 关重件替代组\r\n\t\trelation: {\r\n\t\t\tA0809:{alternateGroup: \"111\"},\r\n\t\t\tB0809:{alternateGroup: \"222\"},\r\n\t\t\tS0809:{alternateGroup: \"111\"}\r\n\t\t},\r\n\t\tgroup: {\r\n\t\t\t111: {\r\n\t\t\t\tcount: 0,// 同组关重件，当前已采集数量\r\n\t\t\t\tmaxCount: \"3\",// 同组关重件最多的那一个\r\n\t\t\t},\r\n\t\t\t222: {\r\n\t\t\t\tcount: 0,\r\n\t\t\t\tmaxCount: \"2\",\r\n\t\t\t}\r\n\t\t},\r\n\t\temptyNormalFlag: \"\",// 空表格跳过标记 30.异常跳过 20.正常跳过\r\n\t\tlotBarCode: \"\",// 批次条码输入框数据\r\n\t\tstation: station || {\r\n\t\t\tstationCode: \"\",// 站点代码\r\n\t\t\tstationText: \"\"// 与stationCode一致\r\n\t\t},\r\n\t\t// 013接口参数\r\n\t\tparams013: {\r\n\t\t\tsiteCode: app.siteCode,\r\n\t\t\tstationCode: station.stationCode\r\n\t\t},\r\n\t\tparams001: {\r\n\t\t\tserviceCode: \"GMES-CLIENT-KEYPART001\",\r\n\t\t\tsiteCode: app.siteCode,\r\n\t\t\tstationCode: station.stationCode,\r\n\t\t\tproductNum: \"\",\r\n\t\t\tcreateUser:userCode,\r\n\t\t\tmodifyUser:userCode,\r\n\t\t\tsubAssemblyFlag: 0,\r\n\t\t\tstatusECode: \"\"\r\n\t\t},\r\n\t\tdataTable: null,// dataTable实例化容器\r\n\t\tselectRow: null,// 当前选中行\r\n\t\t$currentNum: $(\"#currentNum\"),// 剩余采集条数\r\n\t\t$allNum: $(\"#allNum\"),// 总共条数\r\n\t\t$productmark: $(\"#productmark\"),// 产品标识输入框\r\n\t\t$lotBarCodeInput: $(\"#lotBarCodeInput\"),// 批次条码输入框\r\n\t\t$ipCollectBatchNumber: $(\"#ipCollect-batchNumber\"),// 批次修改输入框\r\n\t\tuserCode: userCode, // 获得用户信息\r\n\t\tundoCount: 0,\r\n\t\t$table:$(\".ipCollect .table-panel table\"),\r\n\t\t// 表格配置参数\r\n\t\tdataTableConfig: {\r\n\t\t\tserverSide: false,// 是否开启服务器模式\r\n\t\t\tpaging: false,// 是否开启本地分页\r\n\t\t\tsearching: false,// 查找效果取消\r\n\t\t\tscrollY: (context.page.height - 158 - 30),// 滚动高度为零\r\n\t\t\torder: [],// 表格在初始化时的排序，与ordering不同\r\n\t\t\tordering: false,// 是否可以排序\r\n\t\t\tdata: [],// 数据源，数组里面嵌套数组\r\n\t\t\tdom: \"<'row'<'col-50'f>> <'row'<'col-100'tr>> <'row'<'col-50'p>>\",// 控制Datatables元素的位置(dom)\r\n\t\t\t// 列配置\r\n\t\t\tcolumns: [{\r\n\t\t\t\tdata: \"keypartCode\",\r\n\t\t\t\trender: function (data, type, row) {\r\n\t\t\t\t\treturn \"<span class='ipCollect-component-value'>\" + row.keypartCode + \"</span>\";\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\tdata: \"supplierCode\",\r\n\t\t\t\trender: function (data, type, row) {\r\n\t\t\t\t\treturn \"<a class='f-cp ipCollect-open-picker-supplier-value ipCollect-open-picker'>\" + row.supplierCode + \"</a>\";\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\tdata: \"lotNum\",\r\n\t\t\t\trender: function (data, type, row) {\r\n\t\t\t\t\treturn \"<a class='f-cp ipCollect-open-picker-batch-value  ipCollect-open-picker'>\" + row.lotNum + \"</a>\";\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\tdata: \"keypartText\",\r\n\t\t\t}, {\r\n\t\t\t\tdata: \"supplierText\",\r\n\t\t\t}, {\r\n\t\t\t\trender: function () {\r\n\t\t\t\t\treturn \"<button class='cancel'>\" + i18next.t(\"KEYPART.B.REPEAL\") + \"</button>\";// 移除\r\n\t\t\t\t},\r\n\t\t\t}],\r\n\t\t\t// 表格行(Row)绘制的回调函数\r\n\t\t\trowCallback: function (row, data) {\r\n\t\t\t\t// 状态码为2，添加错误类\r\n\t\t\t\tif (data.statusEcode == 2) {\r\n\t\t\t\t\t// 为每个td加上error类\r\n\t\t\t\t\t$(row).children().addClass('error');\r\n\t\t\t\t\t$(row).children('td').children('button').addClass('delBtn');\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 是否合法\r\n\t\t\t\tif (data.invalid === true) {\r\n\t\t\t\t\t$(row).addClass(\"invalid\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n}\r\n\r\nvar ipCollectCtrl = {\r\n\tpage: undefined,\r\n\tinit: function () {\r\n\r\n\t\tutil.translate(this.page);\r\n\t\tsecurity.isUniqueOperableStation((station) => {\r\n\t\t\t// 设置模块以及参数\r\n\t\t\tsetOptions(station, this);\r\n\r\n\t\t\t// 实例化表格\r\n\t\t\toptions.dataTable = options.$table.DataTable(options.dataTableConfig);\r\n\r\n\t\t\t// 判断对应站点是否为关重件普通站点,不是则返回主页面\r\n\t\t\tutil.service(\"GMES-CLIENT-KEYPART013\", options.params013)\r\n\t\t\t\t.done((response) => {\r\n\t\t\t\t\tutil.rightCode(response,(response) => {\r\n\t\t\t\t\t\tif (response.data === true) {\r\n\t\t\t\t\t\t\t// 设置标题\r\n\t\t\t\t\t\t\tutil.setBreadcrumb([i18next.t(\"KEYPART.T.MENU_COLLECT\") + \" \" + options.station.stationCode]);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// 初始化事件\r\n\t\t\t\t\t\t\tthis.event();\t\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tnotie.force({\r\n\t\t\t\t\t\t\t\ttype: 3,\r\n\t\t\t\t\t\t\t\ttext: i18next.t(\"COMMON.T.MSG_INVALID_PERMISSIONS\"),// 请核对用户权限！ (站点生效版本)\r\n\t\t\t\t\t\t\t\tbuttonText: '知道了',\r\n\t\t\t\t\t\t\t\tcallback: function () {util.returnHome();}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t});\r\n\t},\r\n\t// 事件\r\n\tevent: function () {\r\n\t\t// 初始化光标显示在产品标识中\r\n\t\t$(\"#productmark\").focus();\r\n\t\t\t\t\r\n\t\t// 点击关闭时获取批次条码焦点\r\n\t\t$('.close-picker').on('click', function () {$('#lotBarCodeInput').focus();});\r\n\r\n\t\tthis.saveEvent();\r\n\t\tthis.tableEvent();\r\n\t\tthis.productmarkEvent();\r\n\t\tthis.lotBarCodeInputEvent();\r\n\t\tthis.confirmEvent();\r\n\t\tthis.deleteEvent();\r\n\t},\r\n\t// 点击一行，从下侧弹出可修改的弹出框\r\n\ttableEvent: function() {\r\n\t\tvar _this = this;\r\n\t\t$(\".table-panel tbody\").on(\"click\", \"tr:not(.invalid)\", function(event) {\r\n\r\n\t\t\t// 如果是空行或是删除按钮，则不触发点击效果\r\n\t\t\tif ($(event.target).hasClass(\"dataTables_empty\") || $(event.target).hasClass(\"cancel\")) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// 获取行号，只要在row方法中填入dom就能获取数据\r\n\t\t\toptions.selectRow = options.dataTable.row(this);\r\n\t\t\t_this.setInputVal();\r\n\t\t\t_this.selectDefaultVendor()\r\n\t\t\t\t.then(function() {myApp.popup('.picker-modal');});\r\n\t\t\t\r\n\t\t\t\r\n\t\t});\r\n\t},\r\n\tsetInputVal: function() {\r\n\t\t// 获取当前行数据源\r\n\t\tvar data = options.selectRow.data();\r\n\t\t$(\"#ipCollect-component\").val(data[\"keypartCode\"]);\r\n\t\t$(\"#ipCollect-batchNumber\").val(data[\"lotNum\"]);\r\n\t},\r\n\t/**\r\n\t * 设置状态码\r\n\t * 供应商和批次条码都为空，为未采，状态0\r\n\t * 供应商和批次条码都有，为已采正常，状态1\r\n\t * 供应商和批次条码有一个为空，为已采异常，状态2\r\n\t * @param {*} supplierCode 供应商\r\n\t * @param {*} lotNum 批次代码\r\n\t * @param {*} subAssemblyFlag  1.本厂不需要验证 0.外厂需要验证\r\n\t */\r\n\tsetStatusEcode: function(supplierCode, lotNum, subAssemblyFlag) {\r\n\t\t\r\n\t\treturn new Promise((resolve) => {\r\n\t\t\tvar status = 2;// 默认一个为空\r\n\r\n\t\t\t// 供应商与批次代码都没填\r\n\t\t\tif (supplierCode === \"\" && lotNum === \"\") {\r\n\t\t\t\tstatus = 0;\r\n\t\t\t\tresolve(status);\r\n\t\t\t// 供应商与批次代码都填了\r\n\t\t\t} else if (supplierCode !== \"\"  && lotNum !== \"\") {\r\n\t\t\t\t\r\n\t\t\t\t//分装标识为1，且供应商不为空\r\n\t\t\t\tif (subAssemblyFlag == 1) {\r\n\t\t\t\t\tstatus = 1;\r\n\t\t\t\t\tresolve(status);\r\n\r\n\t\t\t\t//分装标识不为1(外部厂商供应，需要验证)，且供应商不为空\r\n\t\t\t\t} else if (subAssemblyFlag != 1) {\r\n\r\n\t\t\t\t\tutil.service(\"GMES-CLIENT-KEYPART011\",{\r\n\t\t\t\t\t\tsiteCode: app.siteCode,\r\n\t\t\t\t\t\tmaterialCode: options.selectRow.data().keypartCode,\r\n\t\t\t\t\t\tsupplierCode: supplierCode\r\n\t\t\t\t\t}, \"正在检验物料供应商关系\")\r\n\t\t\t\t\t\t.done(function (response) {\r\n\t\t\t\t\t\t\tutil.rightCode(response, function(response) {\r\n\t\t\t\t\t\t\t\t// 判断数据有效性\r\n\t\t\t\t\t\t\t\tif (response.data === true) {\r\n\t\t\t\t\t\t\t\t\tstatus = 1;\r\n\t\t\t\t\t\t\t\t\tresolve(status);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tresolve(status);\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\t\t\t\tresolve(status);\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\t/**\r\n\t * 返回采集数量的增减 +1，-1\r\n\t * @param {number} statusEcodeNew 修改后的新状态码\r\n\t * @param {\"0\", 0, \"\", null} statusEcodeOld 旧状态码\r\n\t */\r\n\tgetCountChange: function(statusEcodeNew, statusEcodeOld) {\r\n\t\tvar count = 0;\r\n\t\tvar flag;\r\n\r\n\t\tstatusEcodeOld = parseInt(statusEcodeOld);\r\n\t\tflag = (statusEcodeOld === 0 || !statusEcodeOld);\r\n\r\n\t\t// 旧的未采 && 新状态码已经采过，数量 -1\r\n\t\tif (flag && statusEcodeNew !== 0) {\r\n\t\t\tcount = -1;\r\n\t\t\r\n\t\t// 如果旧的采过，新的没踩，数量+1\r\n\t\t} else if (statusEcodeOld > 0 && statusEcodeNew === 0) {\r\n\t\t\tcount = +1;\r\n\t\t}\r\n\r\n\t\t// 改变未采集数目\r\n\t\toptions.undoCount += count;\r\n\t\toptions.$currentNum.text(options.undoCount);\r\n\r\n\t\treturn count;\r\n\t},\r\n\tdeleteEvent: function() {\r\n\t\tvar _this = this;\r\n\t\t$(\".table-panel tbody\").on(\"click\", \".cancel\", function() {\r\n\r\n\t\t\toptions.selectRow = options.dataTable.row($(this).parents(\"tr\"));\r\n\t\t\tvar rowData = options.selectRow.data();// 当前行数据\r\n\r\n\t\t\tif (rowData.supplierCode || rowData.lotNum || rowData.supplierText) {\r\n\t\t\t\trowData.supplierCode = rowData.lotNum = rowData.supplierText = \"\";\r\n\t\t\t\t\r\n\t\t\t\t_this.saveToTable(rowData);\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\tconfirmEvent: function () {\r\n\t\t$(\".ipCollect\").on('click', \".ipCollect-confirm\", () => {\r\n\r\n\t\t\tvar rowData = options.selectRow.data();// 当前行数据\r\n\t\t\t\r\n\t\t\trowData.supplierCode = $('input:radio[name=\"provider\"]:checked').val() || \"\";// 供应商代码\r\n\t\t\trowData.lotNum = $(\"#ipCollect-batchNumber\").val().toUpperCase() || \"\";// 批次\r\n\t\t\trowData.supplierText = $('input:radio[name=\"provider\"]:checked').next().children('span').text() || \"\";// 供应商信息\r\n\r\n\t\t\tthis.saveToTable(rowData);\r\n\t\t\tmyApp.closeModal('.picker-info');\r\n\t\t});\r\n\t},\r\n\t/**\r\n\t * 表格数据排序,并重新渲染\r\n\t * 用新数据替换老数据，如果长度 > 1, 将首行有采集的第一个数据放到最后。\r\n\t * @param {*} afterEditSelectRowData 修改后的新行数据\r\n\t */\r\n\tsortData: function(afterEditSelectRowData) {\r\n\t\t\tvar dataTableArr = options.dataTable.data();//获取表格数据\r\n\t\t\tvar rowIndex = options.selectRow.index();// 当前行序号从0开始\r\n\r\n\t\t\t// 删除当前行数据\r\n\t\t\tdataTableArr.splice(rowIndex, 1);\r\n\r\n\t\t\t// 如果长度 > 1, 将首行有采集的第一个数据放到最后\r\n\t\t\tif (dataTableArr.length > 1) {\r\n\t\t\t\tvar tableDataFirst = dataTableArr[0];// 拿到第一行数据\r\n\r\n\t\t\t\tif (tableDataFirst.statusEcode == 1 || tableDataFirst.statusEcode == 2) {\r\n\t\t\t\t\tdataTableArr.shift();// 将第一行放到最后\r\n\t\t\t\t\tdataTableArr.push(tableDataFirst);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// 用新数据插到第一行。\r\n\t\t\tdataTableArr.unshift(afterEditSelectRowData);\r\n\r\n\t\t\t\r\n\t\t\toptions.dataTable.clear();// 清空表格数据\r\n\t\t\toptions.dataTable.rows.add(dataTableArr);// 添加数据并重绘\r\n\r\n\t\t\t// 回到页面顶部\r\n\t\t\toptions.$table.parent().scrollTop(0);\r\n\r\n\t\t\treturn dataTableArr;\r\n\t},\r\n\tsetInvalid:function(selectRowData, countChange) {\r\n\t\tvar keypartCode = selectRowData.keypartCode;// 物料编码\r\n\t\t// 存在关重件替代组(备用关系)\r\n\t\tif (options.relation[keypartCode]) {\r\n\r\n\t\t\tvar flag = false;\r\n\t\t\tvar alternateGroup = options.relation[keypartCode].alternateGroup;\r\n\t\t\t\r\n\t\t\t// 备用组剩余数量\r\n\t\t\toptions.group[alternateGroup].count -= countChange;\r\n\r\n\t\t\t// 设置合法性\r\n\t\t\tif (options.group[alternateGroup].count >= options.group[alternateGroup].maxCount) {\r\n\t\t\t\tflag = true;\r\n\t\t\t}\r\n\r\n\t\t\t// 进行渲染\r\n\t\t\toptions.dataTable\r\n\t\t\t\t.rows(function (index, data) {\r\n\t\t\t\t\tvar flag = (data.alternateGroup === alternateGroup) && (data.statusEcode != 1) && (data.statusEcode != 2);\r\n\t\t\t\t\treturn flag;\r\n\t\t\t\t})\r\n\t\t\t\t.every(function () {\r\n\r\n\t\t\t\t\t// 赋予合法性\r\n\t\t\t\t\tvar data = this.data();\r\n\t\t\t\t\tdata.invalid = flag;\r\n\t\t\t\t});\r\n\t\t}\r\n\t},\r\n\t// 保存数据到表格的操作\r\n\tsaveToTable: function(selectRowData) {\r\n\r\n\t\t// 设置新状态码\r\n\t\tthis.setStatusEcode(selectRowData.supplierCode, selectRowData.lotNum, selectRowData.subAssemblyFlag)\r\n\t\t\t.then((statusEcodeNew) => {\r\n\t\t\t\tvar countChange = this.getCountChange(statusEcodeNew, selectRowData.statusEcode);// 采集数量变化\r\n\r\n\t\t\t\tselectRowData.statusEcode = statusEcodeNew;// 新状态码\r\n\t\t\t\t\r\n\t\t\t\t// 对表格排序渲染\r\n\t\t\t\tthis.sortData(selectRowData);\r\n\r\n\t\t\t\t// 设置有效性\r\n\t\t\t\tthis.setInvalid(selectRowData, countChange);\r\n\t\t\t\t\r\n\t\t\t\t// 重绘表格\r\n\t\t\t\toptions.dataTable.draw();\r\n\t\t\t});\r\n\t},\r\n\t// 空表保存\r\n\temptySaveAajx: function () {\r\n\r\n\t\toptions.params001.productNum = options.$productmark.val().toUpperCase();\r\n\t\toptions.params001.statusECode = options.emptyNormalFlag;\r\n\r\n\t\tapp.request({\r\n\t\t\turl: \"restful/service/execute\",\r\n\t\t\tdata: options.params001,\r\n\t\t\tsuccess: function (response) {\r\n\t\t\t\tif (response.returnCode === \"0\") {\r\n\t\t\t\t\tnotie.alert({ type: \"1\", text: \"标记成功！\"});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnotie.alert({ text: response.errorMessage });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\toptions.$productmark.focus().select();\r\n\t},\r\n\temptySave: function () {\r\n\t\tvar _this = this;\r\n\t\tmyApp.modal({\r\n\t\t\ttitle: 'iME提示',\r\n\t\t\ttext: '清单为空，跳过请标记',\r\n\t\t\tbuttons: [\r\n\t\t\t\t{\r\n\t\t\t\t\ttext: '异常',\r\n\t\t\t\t\tonClick: function () {\r\n\t\t\t\t\t\toptions.emptyNormalFlag = \"30\";\r\n\t\t\t\t\t\t_this.emptySaveAajx();\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\ttext: '正常',\r\n\t\t\t\t\tbold: true,\r\n\t\t\t\t\tonClick: function () {\r\n\t\t\t\t\t\toptions.emptyNormalFlag = \"20\";\r\n\t\t\t\t\t\t_this.emptySaveAajx();\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t]\r\n\t\t});\r\n\t},\r\n\tdisabledInput: function (selector, disabled) {\r\n\t\tselector.attr('disabled', disabled);\r\n\t},\r\n\t// 根据产品标识号获取扫描清单\r\n\tgetListDataFromServer: function () {\r\n\t\tutil.service('GMES-CLIENT-KEYPART003', {\r\n\t\t\tsiteCode: app.siteCode,\r\n\t\t\tstationCode: options.station.stationCode,\r\n\t\t\tproductNum: options.$productmark.val().toUpperCase()\r\n\t\t},\"正在获取扫描清单\")\r\n\t\t\t.done((response) => {util.rightCode(response, this.createTable, this);})\r\n\t\t\t.fail(() => {options.$productmark.focus().select();});\r\n\t},\r\n\t// 如果首次采集，并且扫描清单为空，弹出是否正常跳过\r\n\temptyList: function(first) {\r\n\t\tif (first) {\r\n\t\t\tthis.emptySave();\r\n\t\t} else {\r\n\t\t\tnotie.alert({text: i18next.t(\"KEYPART.T.MSG_RECORDLIST_IS_EMPTY\")});// 扫描列表为空\r\n\t\t\toptions.dataTable.clear().draw();\r\n\t\t\toptions.$productmark.focus().select();\r\n\t\t}\r\n\t},\r\n\tfullList: function(data) {\r\n\t\tvar quantity = data.quantity;// 每个组的数量\r\n\t\tvar arr = [];\r\n\t\tfor (var j = 0; j < quantity; j++) {\r\n\t\t\tdata.lotNum = \"\";//本来是null\r\n\t\t\tdata.supplierCode = \"\";\r\n\t\t\tarr.push($.extend(true, {}, data));\r\n\t\t}\r\n\t\treturn arr;\r\n\t},\r\n\tremoveNull: function(data) {\r\n\t\tif (!data.lotNum) {\r\n\t\t\tdata.lotNum = \"\";\r\n\t\t}\r\n\r\n\t\tif (!data.supplierCode) {\r\n\t\t\tdata.supplierCode = \"\";\r\n\t\t}\r\n\r\n\t\treturn data;\r\n\t},\r\n\t// 渲染dom数量\r\n\trenderCount: function(keypartCount, validCount) {\r\n\t\t// 渲染dom\r\n\t\toptions.$allNum.text(keypartCount);\r\n\t\toptions.undoCount = keypartCount - (validCount || 0);\r\n\t\toptions.$currentNum.text(options.undoCount);\r\n\t},\r\n\t/**\r\n\t * 有替代组的组件在替代组关系中维护关系对象，扫描数量中替代组只计算最大的一个\r\n\t * 所以等维护好替代组关系之后再计算\r\n\t * 替代组关系中，维护一个关重件对象\r\n\t * A0809:{alternateGroup: \"111\"}\r\n\t */\r\n\tfirstCollect: function(data) {\r\n\r\n\t\tvar keypartCount = 0;// 需要采集的关重件数量\r\n\t\tvar list = [];// 根据quantity，生产去除物料号与供应商的新长数组\r\n\t\tvar relation = options.relation = {}; //加载数据时，初始化一个空的替代组关系对象，\r\n\t\toptions.group = {};\r\n\r\n\t\tkit.forEach(data, (item) => {\r\n\r\n\t\t\tvar quantity = item.quantity;\r\n\t\t\tvar alternateGroup = item.alternateGroup;// 替代组\r\n\t\t\tvar keypartCode = item.keypartCode;// 物料编码\r\n\r\n\t\t\t// 填充数组\r\n\t\t\tlist = list.concat(this.fullList(item));\r\n\r\n\t\t\tif (alternateGroup) {\r\n\t\t\t\t//替代组关系中，维护一个关重件对象 \"B0809: {alternateGroup: 111}\"\r\n\t\t\t\trelation[keypartCode] = {\r\n\t\t\t\t\talternateGroup: alternateGroup\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\t// 如果已有关重件替代组，其数量取其中关重件数量最大的一个\r\n\t\t\t\tif (options.group[alternateGroup]) {\r\n\t\t\t\t\tif (quantity > options.group[alternateGroup].maxCount) {\r\n\t\t\t\t\t\toptions.group[alternateGroup].maxCount = quantity;\r\n\t\t\t\t\t}\r\n\t\t\t\t// 如果没有关重件替代组，则新维护一个替代组对象\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.group[alternateGroup] = {\r\n\t\t\t\t\t\tcount: 0,\r\n\t\t\t\t\t\tmaxCount: quantity\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\t\t\t\t// 没有替代组的组件直接计算在扫描数量中\r\n\t\t\t\tkeypartCount += parseInt(quantity);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// 关重件替代组数量加到扫描清单数量中去\r\n\t\tkit.forEach(options.group, (item) => {\r\n\t\t\t\tkeypartCount += parseInt(item.maxCount);\r\n\t\t});\r\n\r\n\t\t// 渲染dom\r\n\t\tthis.renderCount(keypartCount);\r\n\t\t\r\n\t\treturn list;\r\n\t},\r\n\tcontinueCollect: function(data) {\r\n\r\n\t\tvar keypartCount = 0;// 需要采集的关重件数量\r\n\t\tvar validCount = 0;// 扫描清单已扫数量\r\n\t\tvar relation = options.relation = {}; //加载数据时，初始化一个空的替代组关系对象\r\n\t\toptions.group = {};\r\n\r\n\t\tkit.forEach(data, (item) => {\r\n\r\n\t\t\tvar alternateGroup = item.alternateGroup;\r\n\t\t\tvar keypartCode = item.keypartCode;// 物料编码\r\n\r\n\t\t\t// 扫描清单已扫数量计数\r\n\t\t\tif (item.statusEcode == 1 || item.statusEcode == 2) {\r\n\t\t\t\tvalidCount++;\r\n\t\t\t}\r\n\r\n\t\t\t// 防止数据变null\r\n\t\t\titem = this.removeNull(item);\r\n\r\n\t\t\t//如果此关重件有替代组，进行\r\n\t\t\tif (alternateGroup) {\r\n\r\n\t\t\t\tif (relation[keypartCode]) {\r\n\t\t\t\t\trelation[keypartCode].maxCount += 1;// 同类\r\n\t\t\t\t//替代组关系中没有此关重件对象则新维护一个关重件对象\r\n\t\t\t\t} else {\r\n\t\t\t\t\trelation[keypartCode] = {\r\n\t\t\t\t\t\tmaxCount: 1,\r\n\t\t\t\t\t\talternateGroup: alternateGroup\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!options.group[alternateGroup]) {\r\n\t\t\t\t\toptions.group[alternateGroup] = {\r\n\t\t\t\t\t\tmaxCount: 0,\r\n\t\t\t\t\t\tcount: 0\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 替代组中已扫数量统计\r\n\t\t\t\tif (item.statusEcode == 1 || item.statusEcode == 2) {\r\n\t\t\t\t\toptions.group[alternateGroup].count++;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// 没有替代组的组件直接计算在扫描数量中\r\n\t\t\t\tkeypartCount++;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// 遍历替代组关系中关重件对象，设置关重件对象中数量最大值为替代组对象数量\r\n\t\tkit.forEach(relation, (item) => {\r\n\t\t\tvar alternateGroup = item.alternateGroup;\r\n\t\t\tif (item.maxCount > options.group[alternateGroup].maxCount) {\r\n\t\t\t\toptions.group[alternateGroup].maxCount = item.maxCount;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tkit.forEach(options.group, (item, key) => {\r\n\t\t\t// 关重件替代组数量加到扫描清单数量中去\r\n\t\t\tkeypartCount += item.maxCount;\r\n\r\n\t\t\t// 如果该替代组数量已满，则将表格中其他未扫的关重件及替代组的扫描清单处置为灰色\r\n\t\t\tif (item.count >= item.maxCount) {\r\n\r\n\t\t\t\toptions.dataTable.rows(function (idx, data) {\r\n\t\t\t\t\treturn (data.alternateGroup === key) && (data.statusEcode != 1) && (data.statusEcode != 2);\r\n\t\t\t\t}).every(function () {\r\n\t\t\t\t\tvar data = this.data();\r\n\t\t\t\t\tdata.invalid = true;\r\n\t\t\t\t});\r\n\t\t\t\toptions.dataTable.draw();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// 渲染dom\r\n\t\tthis.renderCount(keypartCount, validCount);\t\r\n\r\n\t\treturn data;\r\n\t},\r\n\tcreateTable: function (response) {\r\n\r\n\t\tvar data = response.data.list;\r\n\t\tvar length = data.length;\r\n\t\tvar first = response.data.first;// 是否是首次采集标识\r\n\r\n\t\tif (length <= 0) {\r\n\t\t\tthis.emptyList(first);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 如果首次采集\r\n\t\tif (first) {\r\n\t\t\tdata = this.firstCollect(data);\r\n\t\t\toptions.dataTable.clear();\r\n\t\t\toptions.dataTable.rows.add(data).draw();\r\n\t\t\toptions.$lotBarCodeInput.focus();\r\n\t\t\r\n\t\t// 如果之前采集过\r\n\t\t} else {\r\n\t\t\tdata = this.continueCollect(data);\r\n\t\t\toptions.dataTable.clear();\r\n\t\t\toptions.dataTable.rows.add(data).draw();\r\n\t\t}\r\n\t\t\r\n\t\t$('.head-confirm').removeClass(\"disabled\");\r\n\t},\r\n\tloadTableByProductNum: function () {\r\n\t\tvar _this = this;\r\n\t\t\r\n\t\t// 获取扫描清单前先需校验VIN合法性\r\n\t\tutil.service(\"GMES-CLIENT-KEYPART018\", {\r\n\t\t\tsiteCode: app.siteCode,\r\n\t\t\tstationCode: options.station.stationCode,\r\n\t\t\tproductNum: options.$productmark.val().toUpperCase()\r\n\t\t}, \"VIN号校验中\")\r\n\t\t\t.done(function (response) {\r\n\r\n\t\t\t\tutil.rightCode(response, function (response) {\r\n\t\t\t\t\tvar rsCode = response.data;\r\n\r\n\t\t\t\t\t// 1：成功，程序继续运行，无提示信息\r\n\t\t\t\t\tif (rsCode === \"1\") {\r\n\t\t\t\t\t\t_this.disabledInput(options.$productmark, 'disabled');\r\n\t\t\t\t\t\t_this.getListDataFromServer();\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 2：异常，程序提示：产品标识号不连续，请核查！程序仍可继续操作\r\n\t\t\t\t\t} else if (rsCode === \"2\") {\r\n\t\t\t\t\t\tnotie.alert({type: 2, text: \"产品标识号不连续\" });\r\n\t\t\t\t\t\t_this.disabledInput(options.$productmark, 'disabled');\r\n\t\t\t\t\t\t_this.getListDataFromServer();\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 0：失败，提示“无效的产品标识号”，不允许后续操作。\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t$('.head-confirm').addClass(\"disabled\");\r\n\t\t\t\t\t\tnotie.alert({ text: \"无效的产品标识号\" });\r\n\t\t\t\t\t\toptions.$productmark.focus().select();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t})\r\n\t\t\t.fail(function () {\r\n\t\t\t\t// notie.alert({ text: \"VIN校验失败\" });\r\n\t\t\t\toptions.$productmark.focus().select();\r\n\t\t\t});\r\n\r\n\t\t$('#lotBarCodeInput').focus().select();\r\n\t},\r\n\tproductmarkEvent: function () {\r\n\t\tvar _this = this;\r\n\t\tvar $productmark = options.$productmark;\r\n\t\t$productmark.keyup(function (event) {\r\n\r\n\t\t\tthis.value = util.filter(this.value);\r\n\r\n\t\t\tif (event.keyCode == 13 && this.value !== \"\") {\r\n\t\t\t\t$productmark.focus().select();\r\n\t\t\t\t$(\"div.productmark\").remove();\r\n\t\t\t\t_this.loadTableByProductNum();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\toptions.$ipCollectBatchNumber.keyup(function () {\r\n\t\t\tthis.value = util.filter(this.value);\r\n\t\t});\r\n\t},\r\n\tlotBarCodeInputEvent: function () {\r\n\t\tvar $lotBarCodeInput = options.$lotBarCodeInput;\r\n\t\tvar _this = this;\r\n\t\t$lotBarCodeInput.keyup(function (event) {\r\n\r\n\t\t\tthis.value = util.filter(this.value);\r\n\t\t\tvar code = this.value;\r\n\t\t\tif (event.keyCode == 13 && code) {\r\n\t\t\t\t$lotBarCodeInput.focus().select();\r\n\r\n\t\t\t\tutil.service('GMES-CLIENT-KEYPART002',{\r\n\t\t\t\t\tsiteCode: app.siteCode,\r\n\t\t\t\t\tbarcode: code.toUpperCase()\r\n\t\t\t\t})\r\n\t\t\t\t\t.done((response) => {\r\n\t\t\t\t\t\tutil.rightCode(response, function(response) {\r\n\t\t\t\t\t\t\t_this.dealKeypartCode(response);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.fail(function () {\r\n\t\t\t\t\t\tnotie.alert({\r\n\t\t\t\t\t\t\ttext: \"批次条码没有当前长度规则，可通过后台配置\",//i18next.t(\"KEYPART.T.MSG_BATCH_NO_ERROR\", {length: code.length})// 批次条码没有按照{{length}}位的规则解析！\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\toptions.$lotBarCodeInput.focus().select();\r\n\t\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\t// 根据返回的条码解析结果进行处理-数据填充，表格滚动，采集信息栏更新\r\n\tdealKeypartCode:function (response) {\r\n\r\n\t\t// 根据条码解析结果进行处理\r\n\t\tvar returnData = response.data;\r\n\t\tvar materialCode = returnData.materialCode;\r\n\r\n\t\t// 如果是有替代组的关重件或者替代组，则标记，并检查有替代组的关重件的已扫的关重件和替代组的数量已满，则提示，并退出\r\n\t\tvar keypartCode;\r\n\t\tif (options.relation[materialCode]) {\r\n\t\t\tkeypartCode = options.relation[materialCode].alternateGroup;\r\n\t\t\tif (options.relation[keypartCode].count >= options.relation[keypartCode].maxCount) {\r\n\t\t\t\tnotie.alert({ text: \"组件数量已满！\" });\r\n\t\t\t\toptions.$lotBarCodeInput.focus().select();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// 根据返回的关重件物料编码选到对应的关重件\r\n\t\toptions.selectRow = options.dataTable.row(function (idx, data) {\r\n\t\t\treturn (data.materialCode === materialCode && data.invalid !== true && data.statusEcode != 1 && data.statusEcode != 2);\r\n\t\t});\r\n\r\n\t\tvar rowSelectMatch = options.dataTable.row(function (idx, data) {\r\n\t\t\treturn (data.materialCode === materialCode && (data.statusEcode == 1 || data.statusEcode == 2));\r\n\t\t});\r\n\r\n\t\tvar seleceRowData = options.selectRow.data();\r\n\t\tvar rowMatchData = rowSelectMatch.data();\r\n\r\n\t\tif (seleceRowData) {\r\n\t\t\t// 将对应的关重件的供应商和批次进行填充\r\n\t\t\tseleceRowData.supplierCode = returnData.supplierCode;\r\n\t\t\tseleceRowData.lotNum = returnData.lotNum;\r\n\t\t\tseleceRowData.supplierText = returnData.supplierText;\r\n\r\n\t\t\tif (returnData.valid) {\r\n\t\t\t\tseleceRowData.statusEcode = 1;\r\n\t\t\t} else {\r\n\t\t\t\tseleceRowData.statusEcode = 2;\r\n\t\t\t}\r\n\r\n\t\t\t// 已扫的放到最后面\r\n\t\t\tthis.sortData(seleceRowData);\r\n\r\n\t\t\t// 重绘表格\r\n\t\t\toptions.dataTable.draw();\r\n\r\n\t\t\t// 扫描数据成功\r\n\t\t\tnotie.alert({ text: i18next.t(\"KEYPART.T.MSG_BATCH_NO_ANALYSE_SUCCESS\") });\r\n\r\n\t\t\t// 当前采集信息栏数据进行更新\r\n\t\t\toptions.undoCount--;\r\n\t\t\toptions.$currentNum.text(options.undoCount);\r\n\r\n\t\t\t// 如果是替代组或有替代组的关重件，则增加替代组关系表中关重件的已扫计数，如果数量已满，则将表格中其他未扫的关重件及替代组的扫描清单处置为灰色\r\n\t\t\tif (keypartCode) {\r\n\t\t\t\toptions.relation[keypartCode].count++;\r\n\t\t\t\tif (options.relation[keypartCode].count >= options.relation[keypartCode].maxCount) {\r\n\t\t\t\t\toptions.dataTable.rows((idx, data) => {\r\n\t\t\t\t\t\treturn (data.alternateGroup === keypartCode) && (data.statusEcode != 1) && (data.statusEcode != 2) ?\r\n\t\t\t\t\t\t\ttrue : false;\r\n\t\t\t\t\t}).every(function () {\r\n\t\t\t\t\t\tvar data = this.data();\r\n\t\t\t\t\t\tdata.invalid = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t\toptions.dataTable.draw();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\toptions.$lotBarCodeInput.val(\"\").focus();\r\n\t\t} else {\r\n\t\t\tvar contentMsg = \"无匹配数据！\";\r\n\t\t\tif (rowMatchData) {\r\n\t\t\t\tcontentMsg = \"重复扫描！\";\r\n\t\t\t}\r\n\t\t\tnotie.alert({ text: contentMsg });\r\n\t\t\toptions.$lotBarCodeInput.focus().select();\r\n\t\t}\r\n\r\n\t},\r\n\tselectDefaultVendor: function () {\r\n\t\tvar rowData = options.selectRow.data();\r\n\r\n\t\treturn util.service(\"GMES-CLIENT-KEYPART006\",{\r\n\t\t\tserviceCode: \"GMES-CLIENT-KEYPART006\",\r\n\t\t\tsiteCode: app.siteCode,\r\n\t\t\tmaterialCode: rowData.keypartCode\r\n\t\t},\"正在获取默认供应商数据\")\r\n\t\t\t.done(function (response) {\r\n\t\t\t\tutil.rightCode(response, function(response) {\r\n\r\n\t\t\t\t\tvar renderData = {\r\n\t\t\t\t\t\tsupplierLabel: i18next.t(\"KEYPART.T.SUPPLIER\"),// 供应商\r\n\t\t\t\t\t\tsupplierList: response.data\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tutil.tplManager(\"supplierListTpl\", renderData, \"supplierListRender\");\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 如果供应商列表中有上个页面传过来的供应商，则该供应商默认选中\r\n\t\t\t\t\tvar fromSupplierCode = rowData.supplierCode;\r\n\t\t\t\t\tif (fromSupplierCode) {\r\n\t\t\t\t\t\t$(\"input[name='provider'][value=\" + fromSupplierCode + \"]\").attr(\"checked\", true);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t},\r\n\tsaveEvent: function () {\r\n\t\tvar _this = this;\r\n\t\t$('.head-confirm').on('click', function () {\r\n\t\t\tvar param = {\r\n\t\t\t\tsiteCode: app.siteCode,\r\n\t\t\t\tstationCode: options.station.stationCode,\r\n\t\t\t\tproductNum: options.$productmark.val().toUpperCase(),\r\n\t\t\t\tcreateUser: options.userCode,\r\n\t\t\t\tmodifyUser: options.userCode,\r\n\t\t\t\tsubAssemblyFlag: 0,\r\n\t\t\t\tstatusECode: \"10\"\r\n\t\t\t};\r\n\t\t\tvar tableData = options.dataTable.data();\r\n\t\t\tvar dataLength = tableData.length;\r\n\r\n\t\t\tif (dataLength <= 0) {\r\n\t\t\t\tnotie.alert({ text: \"无提交数据！\" });\r\n\t\t\t\toptions.$productmark.val(\"\").focus();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tfor (var i = 0; i < dataLength; i++) {\r\n\t\t\t\tvar tableDataI = tableData[i];\r\n\r\n\t\t\t\tif ((tableDataI.notNullFlag == 1) && (tableDataI.invalid !== true) && (tableDataI.statusEcode != 1) && (tableDataI.statusEcode != 2)) {\r\n\t\t\t\t\t// XXX 数据不能为空\r\n\t\t\t\t\tnotie.alert({\r\n\t\t\t\t\t\ttext: i18next.t(\"KEYPART.T.MSG_HAVE_NOT_NULL_DATA_SUBMIT\", {\r\n\t\t\t\t\t\t\tkeypartCode: tableDataI.keypartCode\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t});\r\n\t\t\t\t\toptions.$lotBarCodeInput.focus().select();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor (var key in tableDataI) {\r\n\t\t\t\t\tif (tableDataI.hasOwnProperty(key)) {\r\n\t\t\t\t\t\tif ([\"createDate\", \"createDateTime\", \"modifyDate\", \"modifyDateTime\", \"invalid\"].indexOf(key) < 0) {\r\n\t\t\t\t\t\t\tvar keyNew = \"items[\" + i + \"].\" + key;\r\n\t\t\t\t\t\t\tif (key == \"statusEcode\" && (tableDataI[key] == \"\" || tableDataI[key] === null || !(tableDataI[key]))) {\r\n\t\t\t\t\t\t\t\tparam[keyNew] = 0;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tparam[keyNew] = tableDataI[key];\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (options.undoCount > 0) {\r\n\t\t\t\tmyApp.confirm('数据录入不完整，确定要提交？', function () {\r\n\t\t\t\t\t_this.submitConfirm(param);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\t_this.submitConfirm(param);\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\tsaveDataSuccess: function () {\r\n\t\tmyApp.hidePreloader();\r\n\t\tnotie.alert({ text: \"保存数据成功\" });\r\n\r\n\t\tthis.disabledInput(options.$productmark, false);\r\n\t\toptions.dataTable.clear().draw();\r\n\t\toptions.$allNum.text(0);\r\n\t\toptions.$currentNum.text(0);\r\n\t\toptions.$lotBarCodeInput.val(\"\");\r\n\t\toptions.$productmark.val(\"\").focus();\r\n\t},\r\n\tsubmitConfirm: function (param) {\r\n\r\n\t\tutil.service(\"GMES-CLIENT-KEYPART001\",param, \"数据保存中...\")\r\n\t\t\t.done((response) => {\r\n\t\t\t\tutil.rightCode(response, () => {\r\n\t\t\t\t\tthis.saveDataSuccess();\r\n\t\t\t\t});\r\n\t\t\t})\r\n\t\t\t.fail(()=> {\r\n\t\t\t\tmyApp.modal({\r\n\t\t\t\t\ttitle: 'iME',\r\n\t\t\t\t\ttext: '数据保存失败，选择操作',\r\n\t\t\t\t\tbuttons: [\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\ttext: '扫下一个',\r\n\t\t\t\t\t\t\tonClick: function () {\r\n\t\t\t\t\t\t\t\t//  _this.submitAlbe = false;\r\n\t\t\t\t\t\t\t\toptions.dataTable.clear().draw();\r\n\t\t\t\t\t\t\t\toptions.$allNum.text(0);\r\n\t\t\t\t\t\t\t\toptions.$currentNum.text(0);\r\n\t\t\t\t\t\t\t\toptions.$lotBarCodeInput.val(\"\");\r\n\t\t\t\t\t\t\t\t//\toptions.$productmark.val(\"\").focus();\r\n\t\t\t\t\t\t\t\toptions.$productmark.removeAttr(\"disabled\").val(\"\").focus();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\ttext: '继续修改',\r\n\t\t\t\t\t\t\tbold: true,\r\n\t\t\t\t\t\t\tonClick: function () {\r\n\t\t\t\t\t\t\t\toptions.$lotBarCodeInput.focus().select();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t]\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t}\r\n};\r\n\r\nmodule.exports = ipCollectCtrl;\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/js/pages/pqs/ipCollect.js"],"sourceRoot":""}