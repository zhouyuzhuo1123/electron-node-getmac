webpackJsonp([5],{650:function(e,t,a){"use strict";(function(t,o,r,n){var l=(a(35),a(34)),i=(a(666),{selectRow:null,selectRowData:null,initTable:null,page:void 0,$undoCount:void 0,$allCount:void 0,undoCount:0,table:null,printBtnUnable:!0,recordStationCode:void 0,init:function(){var e=this;l.translate(e.page),this.$undoCount=t("#currentNum",this.page),this.$allCount=t("#allNum",this.page),this.$productmark=t("#productmark",this.page),this.$lotBarCodeInput=t("#lotBarCodeInput",this.page),this.$printBtn=t("#printBtn",this.page),e.loadPage(),l.setBreadcrumb([o.t("KEYPART.T.MENU_SUBASSEMBLY_ADDITIONAL")]),e.printBtnUnable=!0,e.$printBtn.addClass("btnDisabled"),this.productmark(),this.lotBarCodeInputEvent(),this.printBtnEvent()},loadPage:function(){var e=this;t("#productmark").focus(),e.removeSubmitEvent();var a=this.page.height-158-53;e.$table=t(".table-panel table",e.page),e.table=t("#myTable",e.page).DataTable({serverSide:!1,paging:!1,searching:!1,scrollY:a,order:[],data:[],dom:"<'row'<'col-50'f>><'row'<'col-100'tr>><'row'<'col-50'p>>",columns:[{data:"keypartCode",name:"keypartCode",orderable:!1,render:function(e,t,a){return'<span class="ipCollect-component-value">'+a.keypartCode+"</span>"}},{className:"supplierCode",data:"supplierCode",name:"supplierCode",orderable:!1,render:function(e,t,a){return'<a style="cursor:pointer;" class="ipCollect-open-picker-supplier-value ipCollect-open-picker">'+(a.supplierCode||"")+"</a>"}},{className:"supplierCode",data:"lotNum",name:"lotNum",orderable:!1,render:function(e,t,a){return'<a style="cursor:pointer;" class="ipCollect-open-picker-batch-value  ipCollect-open-picker">'+(a.lotNum||"")+"</a>"}},{data:"keypartText",name:"keypartText",orderable:!1},{data:"supplierText",name:"supplierText",orderable:!1},{name:"remove",orderable:!1,render:function(e,t,a){return"<button class='cancel' >"+o.t("KEYPART.B.REPEAL")+"</button>"}}],rowCallback:function(a,o,r){t(a).find("td:last-child button").on("click",function(o){e.selectRow=e.table.row(a);var r=e.selectRow.data();if(!t(a).hasClass("invalid")&&(t(this).parent().parent().find("td:eq(1) a").text()||t(this).parent().parent().find("td:eq(2) a").text())){r.lotBarCode="",r.lotNum="",r.supplierCode="",r.supplierText="";var n=r.statusEcode;r.statusEcode=0;var l=e.selectRow.index(),i=e.table.data().toArray();i.splice(l,1);var s=i.length>1?i[0]:void 0;!s||1!=s.statusEcode&&2!=s.statusEcode||(i.splice(0,1),i.push(s)),i.unshift(r),e.table.clear(),e.undoCount++,e.$undoCount.text(e.undoCount),t(a).children().removeClass("error"),t(a).children("td").children("button").removeClass("delBtn"),e.table.rows.add(i).draw();var u;u=n>0?-1:0;var d=r.keypartCode;if(e.alternateRelation[d]){var c=e.alternateRelation[d].alternateForGroup;e.alternateRelation[c].count+=u;var p;p=e.alternateRelation[c].count>=e.alternateRelation[c].maxCount,e.table.rows(function(e,t,a){return t.alternateGroup===c&&1!=t.statusEcode&&2!=t.statusEcode}).every(function(e,t,a){this.data().invalid=p}),e.table.draw()}}o.stopPropagation()}),"2"==o.statusEcode?(t(a).children().addClass("error"),t(a).children("td").children("button").addClass("delBtn")):(t(a).children().removeClass("error"),t(a).children("td").children("button").removeClass("delBtn")),1==o.invalid?t(a).addClass("invalid"):t(a).removeClass("invalid")}}),t("tbody",e.$table).on("click","tr:not(.invalid)",function(){e.selectRow=e.table.row(this);var a=e.selectRow.data();t("#kcopc-component",e.page).val(a.keypartCode),t("#kcopc-batchNumber",e.page).val(a.lotNum),t("#ipCollect-supplier",e.page).val(a.supplierCode),e.initData(),myApp.pickerModal(t(".picker-modal",e.page)),t(".masked").css("display","block")}),t(".masked").on("click",function(){t(this).css("display","none")}),t(".close-picker").on("click",function(t){e.pickermodalclose("#lotBarCodeInput")}),t("#myTable").on("init.dt",function(){e.pickerAndMaskedEvent()}),t(".ipCollect-confirm").on("click",function(){function a(){o=""===i.supplierCode&&""===i.lotNum?0:""!==i.supplierCode&&1==d&&""!==i.lotNum?1:2,n=(0==u||!u||""==u)&&o>0?1:u>0&&0==o?-1:0,i.statusEcode=o,e.table.row(s).data(i).draw();var t=e.table.data().toArray();t.splice(s,1);var a=t.length>1?t[0]:void 0;!a||1!=a.statusEcode&&2!=a.statusEcode||(t.splice(0,1),t.push(a)),t.unshift(i),e.table.clear(),e.table.rows.add(t).draw(),e.$table.parent().scrollTop(0),e.undoCount-=n,e.$undoCount.text(e.undoCount);var r=i.keypartCode;if(e.alternateRelation[r]){var l=e.alternateRelation[r].alternateForGroup;e.alternateRelation[l].count+=n,e.alternateRelation[l].count>=e.alternateRelation[l].maxCount?e.table.rows(function(e,t,a){return t.alternateGroup===l&&1!=t.statusEcode&&2!=t.statusEcode}).nodes().to$().addClass("invalid"):e.table.rows(function(e,t,a){return t.alternateGroup===l&&1!=t.statusEcode&&2!=t.statusEcode}).nodes().to$().removeClass("invalid")}}t(".masked").css("display","none");var o,n,i=e.selectRow.data(),s=e.selectRow.index(),u=i.statusEcode;i.supplierCode=t('input:radio[name="provider"]:checked').val()||"",i.lotNum=t("#ipCollect-batchNumber").val().toUpperCase()||"",i.supplierText=t('input:radio[name="provider"]:checked').next().children("span").text()||"";var d;if(1!=i.subAssemblyFlag&&""!==i.supplierCode){var c=function(e){d=1==e.data,a()};r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART011",siteCode:r.siteCode,materialCode:e.selectRow.data().keypartCode,supplierCode:i.supplierCode},success:function(e){l.rightCode(e,c)}})}else 1==i.subAssemblyFlag&&""!==i.supplierCode?(d=!0,a()):(d=!1,a())}),t(".close-picker").on("click",function(){t(".masked").css("display","none")})},printBtnEvent:function(){var e=this;e.$printBtn.click(function(){if(e.printBtnUnable)return void n.alert({text:"打印占用中或无站点信息！"});var a=t.trim(e.$productmark.val());""!=a?(e.printBtnUnable=!0,e.$printBtn.addClass("btnDisabled"),r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART017",siteCode:r.siteCode,stationCode:e.recordStationCode,keyPartCode:a.toUpperCase()},success:function(t){e.printBtnUnable=!1,e.$printBtn.removeClass("btnDisabled"),"0"==t.returnCode?console.log(a+" 打印成功！"):n.alert({text:"打印失败"})},error:function(){e.printBtnUnable=!1,e.$printBtn.removeClass("btnDisabled"),n.alert({text:"打印失败"})}})):(n.alert({text:o.t("KEYPART.T.MSG_SUBASSEMBLY_BARCODE_NO_NOT_BE_NULL")}),e.$productmark.focus())})},loadTableByProductNum:function(){function e(e){var r=e.data.list;a.First=e.data.first;var l=r.length;if(l<=0)return n.alert({text:o.t("KEYPART.T.MSG_RECORDLIST_IS_EMPTY")}),a.printBtnUnable=!0,a.$printBtn.addClass("btnDisabled"),a.table.clear().draw(),void a.$productmark.val("").focus();if(a.addSubmitEvent(),a.recordStationCode=r[0].stationCode,a.recordStationCode&&""!==a.recordStationCode?(a.printBtnUnable=!1,a.$printBtn.removeClass("btnDisabled")):(a.printBtnUnable=!0,a.$printBtn.addClass("btnDisabled")),a.First){var i=[],s=0;a.alternateRelation={};for(var u=0;u<l;u++){for(var d=r[u].quantity,c=0;c<d;c++){var p={};p=t.extend(p,r[u]),p.supplierCode="",p.lotNum="",i.push(p)}r[u].alternateGroup?(a.alternateRelation[r[u].keypartCode]={alternateForGroup:r[u].alternateGroup},a.alternateRelation[r[u].alternateGroup]?d>a.alternateRelation[r[u].alternateGroup].maxCount&&(a.alternateRelation[r[u].alternateGroup].maxCount=d):a.alternateRelation[r[u].alternateGroup]={isGroup:!0,count:0,maxCount:d}):s+=parseInt(d)}for(var C in a.alternateRelation)a.alternateRelation[C].isGroup&&(s+=parseInt(a.alternateRelation[C].maxCount));a.$allCount.text(s),a.$undoCount.text(s),a.undoCount=s,a.table.clear(),a.table.rows.add(i).draw(),a.$lotBarCodeInput.focus()}else{a.table.clear(),a.table.rows.add(r).draw();var s=0,v=0;a.alternateRelation={};for(var u=0;u<l;u++)1!=r[u].statusEcode&&2!=r[u].statusEcode||v++,r[u].alternateGroup?(a.alternateRelation[r[u].keypartCode]?a.alternateRelation[r[u].keypartCode].maxCount+=1:a.alternateRelation[r[u].keypartCode]={maxCount:1,alternateForGroup:r[u].alternateGroup},a.alternateRelation[r[u].alternateGroup]||(a.alternateRelation[r[u].alternateGroup]={isGroup:!0,maxCount:0,count:0}),1!=r[u].statusEcode&&2!=r[u].statusEcode||a.alternateRelation[r[u].alternateGroup].count++):s++;for(var C in a.alternateRelation)if(!a.alternateRelation[C].isGroup){var f=a.alternateRelation[C].alternateForGroup;a.alternateRelation[C].maxCount>a.alternateRelation[f].maxCount&&(a.alternateRelation[f].maxCount=a.alternateRelation[C].maxCount)}for(var C in a.alternateRelation)a.alternateRelation[C].isGroup&&(s+=a.alternateRelation[C].maxCount,a.alternateRelation[C].count>=a.alternateRelation[C].maxCount&&(a.table.rows(function(e,t,a){return t.alternateGroup===C&&1!=t.statusEcode&&2!=t.statusEcode}).every(function(e,t,a){this.data().invalid=!0}),a.table.draw()));a.$allCount.text(s),a.undoCount=s-v,a.$undoCount.text(a.undoCount)}t("#lotBarCodeInput",a.page).focus()}var a=this;r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART012",siteCode:r.siteCode,subAssemblyBarcode:a.$productmark.val().toUpperCase()},success:function(t){l.rightCode(t,e)},error:function(){n.alert({text:"解析失败"}),a.printBtnUnable=!0,a.$printBtn.addClass("btnDisabled"),a.$productmark.focus().select()}})},productmark:function(){var e=this,a=t("#productmark",e.page);a.keyup(function(t){var r=/[^\w\.\/]/gi;if(r.test(this.value)&&(this.value=this.value.replace(r,"")),13==t.keyCode){a.val()?(a.focus().select(),e.loadTableByProductNum()):l.notify({text:o.t("KEYPART.T.MSG_SUBASSEMBLY_BARCODE_NO_NOT_BE_NULL")},function(){a.focus()})}}),t("#ipCollect-batchNumber",this.page).keyup(function(e){var t=/[^\w\.\/]/gi;t.test(this.value)&&(this.value=this.value.replace(t,""))})},lotBarCodeInputEvent:function(){function e(e){r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART002",siteCode:r.siteCode,barcode:e.toUpperCase()},success:function(e){l.rightCode(e,a)},error:function(){n.alert({text:o.t("KEYPART.T.MSG_BATCH_NO_ERROR",{length:e.length})}),i.$lotBarCodeInput.focus().select()}})}function a(e){var t,a=e.data,r=a.materialCode;if(i.alternateRelation[r]&&(t=i.alternateRelation[r].alternateForGroup,i.alternateRelation[t].count>=i.alternateRelation[t].maxCount))return n.alert({text:"组件数量已满！"}),void i.$lotBarCodeInput.focus().select();var l=i.table.row(function(e,t,a){return t.keypartCode===r&&1!=t.invalid&&1!=t.statusEcode&&2!=t.statusEcode}),s=i.table.row(function(e,t,a){return t.keypartCode===r&&(1==t.statusEcode||2==t.statusEcode)}),u=l.data(),d=s.data();if(u){u.supplierCode=a.supplierCode,u.lotNum=a.lotNum,u.supplierText=a.supplierText,a.valid?u.statusEcode=1:u.statusEcode=2;var c=l.index(),p=i.table.data().toArray();p.splice(c,1);var C=p.length>1?p[0]:void 0;!C||1!=C.statusEcode&&2!=C.statusEcode||(p.splice(0,1),p.push(C)),p.unshift(u),i.table.clear(),i.table.rows.add(p).draw(),n.alert({text:o.t("KEYPART.T.MSG_BATCH_NO_ANALYSE_SUCCESS")}),i.undoCount--,i.$undoCount.text(i.undoCount),t&&++i.alternateRelation[t].count>=i.alternateRelation[t].maxCount&&(i.table.rows(function(e,a,o){return a.alternateGroup===t&&1!=a.statusEcode&&2!=a.statusEcode}).every(function(e,t,a){this.data().invalid=!0}),i.table.draw()),i.$lotBarCodeInput.val("").focus()}else{var v=o.t("KEYPART.T.MSG_NO_DATA_MATCH");d&&(v="重复扫描！"),n.alert({text:v}),i.$lotBarCodeInput.focus().select()}}var i=this,s=t("#lotBarCodeInput",i.page);s.keyup(function(a){var r=/[^\w\.\/]/gi;if(r.test(this.value)&&(this.value=this.value.replace(r,"")),13==a.keyCode){var n=s.val();n?(s.focus().select(),t("div.notify").remove(),e(n)):l.notify({text:o.t("KEYPART.T.MSG_BATCH_NO_NOT_BE_NULL")},function(){s.focus()})}})},initData:function(e){function a(e){var a={supplierLabel:o.t("KEYPART.T.SUPPLIER"),supplierList:e.data};r.tplManager("supplierListTpl",a,"supplierListRender");var n=i.supplierCode;n&&t("input[name='provider'][value="+n+"]").attr("checked",!0)}var n=this,i=n.selectRow.data();t("#supplierListRender",n.page).on("click",".content label",function(){t(".batch-input").focus()}),r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART006",siteCode:r.siteCode,materialCode:i.keypartCode},success:function(e){l.rightCode(e,a)}})},headerEvent:function(){var e=this;t(".head-confirm").on("click",function(){!function(){function a(){myApp.showPreloader("数据保存中..."),r.request({url:"restful/service/execute",data:s,success:function(e){l.rightCode(e,i)},error:function(){myApp.hidePreloader(),n.alert({text:o.t("COMMON.T.MSG_SAVE_DATA_FAILURE")})}})}function i(){myApp.hidePreloader(),l.notify({text:"保存数据成功"}),e.removeSubmitEvent(),setTimeout(function(){t("div.notify").remove()},3e3),e.table.clear().draw(),e.$allCount.text(0),e.$undoCount.text(0),e.$lotBarCodeInput.val(""),e.$productmark.val("").focus()}var s={serviceCode:"GMES-CLIENT-KEYPART016",siteCode:r.siteCode,subAssemblyBarcode:e.$productmark.val().toUpperCase(),createUser:e.userCode,modifyUser:e.userCode,subAssemblyFlag:1},u=e.table.data(),d=u.length;if(d<=0)return void n.alert({text:"无提交数据！"});for(var c=0;c<d;c++){var p=u[c];if(1==p.notNullFlag&&1!=p.invalid&&1!=p.statusEcode&&2!=p.statusEcode)return n.alert({text:o.t("KEYPART.T.MSG_HAVE_NOT_NULL_DATA_SUBMIT",{keypartCode:p.keypartCode})}),void e.$lotBarCodeInput.val("").focus();for(var C in p)if(p.hasOwnProperty(C)&&["createDate","createDateTime","modifyDate","modifyDateTime","invalid"].indexOf(C)<0){var v="items["+c+"]."+C;"statusEcode"!=C||""!=p[C]&&null!=p[C]&&p[C]?s[v]=p[C]:s[v]=0}}e.undoCount>0?myApp.confirm("数据录入不完整，确定要提交？",function(){a()}):a()}()})},pickerAndMaskedEvent:function(){var e=this;t(".cancel").on("click",function(){var a=e.table.row(t(this).parent().parent()).data();a.supplier="",a.batch="",e.table.row(t(this).parent().parent()).data(a),t(this).addClass("error")}),t(".close-picker").on("click",function(){t(".masked").css("display","none")})},addSubmitEvent:function(){t(".head-confirm").css("background","#00adee"),this.headerEvent()},removeSubmitEvent:function(){t(".head-confirm").off(),t(".head-confirm").css("background","#CCC")},pickermodalclose:function(e){e&&document.querySelector(e)&&document.querySelector(e).focus()}});e.exports=i}).call(t,a(4),a(37),a(77),a(36))},666:function(e,t,a){"use strict";(function(t){var o=a(34),r=(sessionStorage.getItem("access_token"),t.baseEnv,{getLoginUser:function(e){return o.get("restful/user/getLoginUser",{},"",e)},getUserAllModuleMenus:function(e){}});e.exports=r}).call(t,a(29))}});
//# sourceMappingURL=pqs_keyComponentsOfPackagingMakeup_fb6c5cbc594fb2e2d94b.js.map