webpackJsonp([14],{649:function(e,t,a){"use strict";(function(t,o,r,n){var l=a(35),i=a(34),s={selectRow:null,selectRowData:null,initTable:null,page:void 0,table:null,userCode:null,stationPage:void 0,subAssemblyBarcodeShouldPrint:void 0,init:function(){var e=this;e.initTable&&(e.initTable=void 0),i.translate(e.page),this.lotBarCodeInputEvent(),this.headerEvent(),this.$undoCount=t("#currentNum",this.page),this.$allCount=t("#allNum",this.page),this.$productmark=t("#productmark",this.page),this.$lotBarCodeInput=t("#lotBarCodeInput",this.page),this.$midInput=t(".midInput",this.page),this.$ipCollectBatchNumber=t("#ipCollect-batchNumber",this.page),l.isUniqueOperableStation(function(a){function l(a){1!=a.data?(e.$productmark.attr("disabled","disabled"),e.$midInput.attr("disabled","disabled"),e.$lotBarCodeInput.attr("disabled","disabled"),t("#select").attr("disabled","disabled"),t(".head-confirm").attr("disabled","disabled"),n.force({type:"3",text:o.t("COMMON.T.MSG_INVALID_PERMISSIONS")},function(){Sweet.mainView.router.load({url:"views/index.html"})})):e.loadPageAgain()}e.stationPage=a,e.station=a,e.loadPage(),i.setBreadcrumb([o.t("KEYPART.T.MENU_SUBASSEMBLY_COLLECT")+"("+e.station.stationCode+")"]),i.service("GMES-CLIENT-KEYPART014",{serviceCode:"GMES-CLIENT-KEYPART014",siteCode:r.siteCode,stationCode:e.station.stationCode}).done(function(e){i.rightCode(e,l)})})},loadPageAgain:function(){function e(e){var a=e.data,o=(a.productNum.substr(a.productNum.length-6),a.productNum);t.$productmark.val(o),a.subAssemblyBarcode?(t.subAssemblyBarcodeShouldPrint=!0,t.$midInput.val(a.subAssemblyBarcode).attr("disabled","disabled")):(t.subAssemblyBarcodeShouldPrint=!1,t.$midInput.val("").removeAttr("disabled").focus()),a.productNum&&""!==a.productNum?(t.$lotBarCodeInput.removeAttr("disabled"),t.loadTableByProductNum()):(n.alert({type:"3",text:"产品标识为空！"}),t.$lotBarCodeInput.attr("disabled","disabled"))}var t=this;i.service("GMES-CLIENT-KEYPART005",{siteCode:r.siteCode,stationCode:t.station.stationCode,rowNum:"500"}).done(function(t){i.rightCode(t,e)})},loadPage:function(){var e=this;t("#productmark").focus();var a=this.page.height-158-53;e.$table=t(".table-panel table",e.page),e.table=t("#myTable",e.page).DataTable({serverSide:!1,paging:!1,searching:!1,scrollY:a,order:[],data:[],dom:"<'row'<'col-50'f>><'row'<'col-100'tr>><'row'<'col-50'p>>",columns:[{data:"keypartCode",name:"keypartCode",orderable:!1,render:function(e,t,a){return'<span class="ipCollect-component-value">'+a.keypartCode+"</span>"}},{className:"supplierCode",data:"supplierCode",name:"supplierCode",orderable:!1,render:function(e,t,a){return'<a style="cursor:pointer;" class="ipCollect-open-picker-supplier-value ipCollect-open-picker">'+(a.supplierCode||"")+"</a>"}},{className:"supplierCode",data:"lotNum",name:"lotNum",orderable:!1,render:function(e,t,a){return'<a style="cursor:pointer;" class="ipCollect-open-picker-batch-value  ipCollect-open-picker">'+(a.lotNum||"")+"</a>"}},{data:"keypartText",name:"keypartText",orderable:!1},{data:"supplierText",name:"supplierText",orderable:!1},{name:"remove",orderable:!1,render:function(){return"<button class='cancel' >"+o.t("KEYPART.B.REPEAL")+"</button>"}}],rowCallback:function(a,o){t(a).find("td:last-child button").on("click",function(o){e.selectRow=e.table.row(a);var r=e.selectRow.data();if(!t(a).hasClass("invalid")&&(t(this).parent().parent().find("td:eq(1) a").text()||t(this).parent().parent().find("td:eq(2) a").text())){r.lotBarCode="",r.lotNum="",r.supplierCode="",r.supplierText="",e.table.row(a).data(r).draw();var n=r.statusEcode;r.statusEcode=0;var l=e.selectRow.index(),i=e.table.data().toArray();i.splice(l,1);var s=i.length>1?i[0]:void 0;!s||1!=s.statusEcode&&2!=s.statusEcode||(i.splice(0,1),i.push(s)),i.unshift(r),e.table.clear(),e.undoCount++,e.$undoCount.text(e.undoCount),t(a).children().removeClass("error"),t(a).children("td").children("button").removeClass("delBtn"),e.table.rows.add(i).draw();var d;d=n>0?-1:0;var u=r.keypartCode;if(e.alternateRelation[u]){var c=e.alternateRelation[u].alternateForGroup;e.alternateRelation[c].count+=d;var p;p=e.alternateRelation[c].count>=e.alternateRelation[c].maxCount,e.table.rows(function(e,t,a){return t.alternateGroup===c&&1!=t.statusEcode&&2!=t.statusEcode}).every(function(e,t,a){this.data().invalid=p}),e.table.draw()}}o.stopPropagation()}),"2"==o.statusEcode?(t(a).children().addClass("error"),t(a).children("td").children("button").addClass("delBtn")):(t(a).children().removeClass("error"),t(a).children("td").children("button").removeClass("delBtn")),1==o.invalid?t(a).addClass("invalid"):t(a).removeClass("invalid")}}),t("#myTable").on("init.dt",function(){e.pickerAndMaskedEvent()}),t(".close-picker").on("click",function(){t(".masked").css("display","none")}),t("tbody",e.$table).on("click","tr:not(.invalid)",function(){e.selectRow=e.table.row(this);var a=e.selectRow.data();t("#ipCollect-component",e.page).val(a.keypartCode),t("#ipCollect-batchNumber",e.page).val(a.lotNum),t("#ipCollect-supplier",e.page).val(a.supplierCode),e.initData(),myApp.pickerModal(t(".picker-1",e.page)),t(".masked").css("display","block")}),t(".masked").on("click",function(){t(this).css("display","none")}),t(".close-picker").on("click",function(){e.pickermodalclose("#lotBarCodeInput")}),t(".ipCollect-confirm").on("click",function(){function a(){o=""===l.supplierCode&&""===l.lotNum?0:""!==l.supplierCode&&1==u&&""!==l.lotNum?1:2,n=(0==d||!d||""==d)&&o>0?1:d>0&&0==o?-1:0,l.statusEcode=o,e.table.row(s).data(l).draw();var t=e.table.data().toArray();t.splice(s,1);var a=t.length>1?t[0]:void 0;!a||1!=a.statusEcode&&2!=a.statusEcode||(t.splice(0,1),t.push(a)),t.unshift(l),e.table.clear(),e.table.rows.add(t).draw(),e.$table.parent().scrollTop(0),e.undoCount-=n,e.$undoCount.text(e.undoCount);var r=l.keypartCode;if(e.alternateRelation[r]){var i=e.alternateRelation[r].alternateForGroup;e.alternateRelation[i].count+=n;var c;c=e.alternateRelation[i].count>=e.alternateRelation[i].maxCount,e.table.rows(function(e,t){return t.alternateGroup===i&&1!=t.statusEcode&&2!=t.statusEcode}).every(function(){this.data().invalid=c}),e.table.draw()}}t(".masked").css("display","none");var o,n,l=e.selectRow.data(),s=e.selectRow.index(),d=l.statusEcode;l.supplierCode=t('input:radio[name="provider"]:checked').val()||"",l.lotNum=t("#ipCollect-batchNumber").val().toUpperCase()||"",l.supplierText=t('input:radio[name="provider"]:checked').next().children("span").text()||"";var u;if(1!=l.subAssemblyFlag&&""!==l.supplierCode){var c=function(e){u=1==e.data,a()};i.service("restful/service/execute",{serviceCode:"GMES-CLIENT-KEYPART011",siteCode:r.siteCode,materialCode:e.selectRow.data().keypartCode,supplierCode:l.supplierCode}).done(function(e){i.rightCode(e,c)})}else 1==l.subAssemblyFlag&&""!==l.supplierCode?(u=!0,a()):(u=!1,a())}),t(".midInput",e.page).keyup(function(a){var o=/[^\w\.\/]/gi;o.test(this.value)&&(this.value=this.value.replace(o,"")),13==a.keyCode&&(a.currentTarget.setAttribute("disabled","ture"),t(".lotBarCodeInput",e.page).focus())}),t("#ipCollect-batchNumber",this.page).keyup(function(){var e=/[^\w\.\/]/gi;e.test(this.value)&&(this.value=this.value.replace(e,""))}),t("#select").on("click",function(){function a(a){t(".infinite-scroll-preloader").remove(),t("#selectTable").removeClass("hidden"),e.initTable.clear(),e.initTable.rows.add(a.data).draw()}myApp.pickerModal(t(".picker-2",e.page)),t(".masked").css("display","block"),e.initTable||(e.initTable=t("#selectTable",this.page).DataTable({serverSide:!1,paging:!1,searching:!1,sScrollY:256,dom:"<'row'<'col-50'f>><'row'<'col-100'tr>><'row'<'col-50'p>>",columnDefs:[{searchable:!1,orderable:!1,targets:0}],ordering:!1,columns:[{name:"index",render:function(e,t,a,o){return parseInt(o.row[0]||o.row)+1}},{data:"productNum",name:"productNum"},{data:"carTypeText",name:"carTypeText"},{name:"add",orderable:!1,render:function(){return"<button class='cancel close-picker add' >"+o.t("COMMON.B.ADD")+"</button>"}}],data:[]}),t("#selectTable",e.page).on("click",".add",function(){t(".masked").css("display","none"),t("#productmark").val(e.initTable.row(t(this).parents("tr")).data().productNum);var a=e.initTable.row(t(this).parents("tr")).data().subAssemblyBarcode;a?(e.subAssemblyBarcodeShouldPrint=!0,e.$midInput.val(a).attr("disabled","disabled")):(e.subAssemblyBarcodeShouldPrint=!1,e.$midInput.val("").removeAttr("disabled").focus()),e.productmark()})),r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART004",siteCode:l.getSiteCode(),stationCode:e.station.stationCode,rowNum:"500"},success:function(e){i.rightCode(e,a)}})})},pickerAndMaskedEvent:function(){t(".close-picker").on("click",function(){t(".masked").css("display","none")}),t(".masked").click(function(){t(this).css("display","none")})},productmark:function(){var e=this,a=t("#productmark",e.page);a.val()?(a.focus().select(),e.loadTableByProductNum()):i.notify({type:"3",text:"产品标识不能为空"},function(){a.focus()})},loadTableByProductNum:function(){function e(e){a.First=e.data.first;var r=e.data.list,l=r.length;if(a.First&&l<=0)return void a.emptySave();if(l<=0)return n.alert({type:"3",text:o.t("KEYPART.T.MSG_RECORDLIST_IS_EMPTY")}),void a.table.clear().draw();if(a.First){var i=[],s=0;a.alternateRelation={};for(var d=0;d<l;d++){for(var u=r[d].quantity,c=0;c<u;c++){var p={};p=t.extend(p,r[d]),p.supplierCode="",p.lotNum="",i.push(p)}r[d].alternateGroup?(a.alternateRelation[r[d].keypartCode]={alternateForGroup:r[d].alternateGroup},a.alternateRelation[r[d].alternateGroup]?u>a.alternateRelation[r[d].alternateGroup].maxCount&&(a.alternateRelation[r[d].alternateGroup].maxCount=u):a.alternateRelation[r[d].alternateGroup]={isGroup:!0,count:0,maxCount:u}):s+=parseInt(u)}for(var C in a.alternateRelation)a.alternateRelation[C].isGroup&&(s+=parseInt(a.alternateRelation[C].maxCount));a.$allCount.text(s),a.$undoCount.text(s),a.undoCount=s,a.table.clear(),a.table.rows.add(i).draw()}else{a.table.clear(),a.table.rows.add(r).draw();var s=0,m=0;a.alternateRelation={};for(var d=0;d<l;d++)1!=r[d].statusEcode&&2!=r[d].statusEcode||m++,r[d].alternateGroup?(a.alternateRelation[r[d].keypartCode]?a.alternateRelation[r[d].keypartCode].maxCount+=1:a.alternateRelation[r[d].keypartCode]={maxCount:1,alternateForGroup:r[d].alternateGroup},a.alternateRelation[r[d].alternateGroup]||(a.alternateRelation[r[d].alternateGroup]={isGroup:!0,maxCount:0,count:0}),1!=r[d].statusEcode&&2!=r[d].statusEcode||a.alternateRelation[r[d].alternateGroup].count++):s++;for(var C in a.alternateRelation)if(!a.alternateRelation[C].isGroup){var v=a.alternateRelation[C].alternateForGroup;a.alternateRelation[C].maxCount>a.alternateRelation[v].maxCount&&(a.alternateRelation[v].maxCount=a.alternateRelation[C].maxCount)}for(var C in a.alternateRelation)a.alternateRelation[C].isGroup&&(s+=a.alternateRelation[C].maxCount,a.alternateRelation[C].count>=a.alternateRelation[C].maxCount&&(a.table.rows(function(e,t,a){return t.alternateGroup===C&&1!=t.statusEcode&&2!=t.statusEcode}).every(function(){this.data().invalid=!0}),a.table.draw()));a.$allCount.text(s),a.undoCount=s-m,a.$undoCount.text(a.undoCount)}a.subAssemblyBarcodeShouldPrint&&t("#lotBarCodeInput").focus()}var a=this;i.service("GMES-CLIENT-KEYPART012",{siteCode:r.siteCode,stationCode:a.station.stationCode,productNum:a.$productmark.val().toUpperCase()}).done(function(t){i.rightCode(t,e)})},lotBarCodeInputEvent:function(){function e(e){r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART002",siteCode:r.siteCode,barcode:e.toUpperCase()},success:function(e){i.rightCode(e,a)},error:function(){n.alert({type:"3",text:o.t("KEYPART.T.MSG_BATCH_NO_ERROR",{length:e.length})}),l.$lotBarCodeInput.focus().select()}})}function a(e){var t,a=e.data,r=a.materialCode;if(l.alternateRelation[r]&&(t=l.alternateRelation[r].alternateForGroup,l.alternateRelation[t].count>=l.alternateRelation[t].maxCount))return n.alert({type:"3",text:"组件数量已满！"}),void l.$lotBarCodeInput.focus().select();var i=l.table.row(function(e,t,a){return t.keypartCode===r&&1!=t.invalid&&1!=t.statusEcode&&2!=t.statusEcode}),s=l.table.row(function(e,t,a){return t.keypartCode===r&&(1==t.statusEcode||2==t.statusEcode)}),d=i.data(),u=s.data();if(d){d.supplierCode=a.supplierCode,d.lotNum=a.lotNum,d.supplierText=a.supplierText,a.valid?d.statusEcode=1:d.statusEcode=2;var c=i.index(),p=l.table.data().toArray();p.splice(c,1);var C=p.length>1?p[0]:void 0;!C||1!=C.statusEcode&&2!=C.statusEcode||(p.splice(0,1),p.push(C)),p.unshift(d),l.table.clear(),l.table.rows.add(p).draw(),n.alert({text:o.t("KEYPART.T.MSG_BATCH_NO_ANALYSE_SUCCESS")}),l.undoCount--,l.$undoCount.text(l.undoCount),t&&++l.alternateRelation[t].count>=l.alternateRelation[t].maxCount&&(l.table.rows(function(e,a,o){return a.alternateGroup===t&&1!=a.statusEcode&&2!=a.statusEcode}).every(function(){this.data().invalid=!0}),l.table.draw()),l.$lotBarCodeInput.val("").focus()}else{var m=o.t("KEYPART.T.MSG_NO_DATA_MATCH");u&&(m="重复扫描！"),n.alert({type:"3",text:m}),l.$lotBarCodeInput.focus().select()}}var l=this,s=t("#lotBarCodeInput",l.page);s.keyup(function(a){var r=/[^\w\.\/]/gi;if(r.test(this.value)&&(this.value=this.value.replace(r,"")),13==a.keyCode){var n=s.val();n?(s.focus().select(),t("div.notify").remove(),e(n)):i.notify({type:"3",text:o.t("KEYPART.T.MSG_BATCH_NO_NOT_BE_NULL")},function(){s.focus()})}})},initData:function(){function e(e){var a={supplierLabel:o.t("KEYPART.T.SUPPLIER"),supplierList:e.data};i.tplManager("supplierListTpl",a,"supplierListRender");var r=n.supplierCode;r&&t("input[name='provider'][value="+r+"]").attr("checked",!0)}var a=this,n=a.selectRow.data();t("#supplierListRender",a.page).on("click",".content label",function(){t(".batch-input").focus()}),r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART006",siteCode:r.siteCode,materialCode:n.keypartCode},success:function(t){i.rightCode(t,e)}})},headerEvent:function(){var e=this;t(".head-confirm").on("click",function(){!function(){function a(){myApp.showPreloader("数据保存中..."),r.request({url:"restful/service/execute",data:p,success:function(e){i.rightCode(e,s)},error:function(){myApp.hidePreloader(),myApp.modal({title:"iME",text:"数据保存失败，选择操作",buttons:[{text:"扫下一个",onClick:function(){e.loadPageAgain()}},{text:"继续修改",bold:!0,onClick:function(){e.$lotBarCodeInput.focus().select()}}]})}})}function l(){e.subAssemblyBarcodeShouldPrint&&r.request({url:"restful/service/execute",data:{serviceCode:"GMES-CLIENT-KEYPART017",siteCode:r.siteCode,stationCode:e.station.stationCode,keyPartCode:c.toUpperCase()},success:function(e){"0"==e.returnCode?console.log(c+" 打印成功！"):n.alert({type:"3",text:"打印失败"})},error:function(){n.alert({type:"3",text:"打印失败"})}})}function s(){l(),myApp.hidePreloader(),n.alert({text:o.t("COMMON.T.MSG_SAVE_DATA_SUCCESS")}),e.table.clear().draw(),e.$allCount.text(0),e.$undoCount.text(0),e.$lotBarCodeInput.val(""),e.loadPageAgain()}var d=e.table.data(),u=d.length;if(u<=0)return void n.alert({type:"3",text:o.t("KEYPART.T.MSG_NO_DATA_TO_SUBMIT")});var c=t.trim(e.$midInput.val());if(""==c)return n.alert({type:"3",text:o.t("KEYPART.T.MSG_SUBASSEMBLY_BARCODE_NO_NOT_BE_NULL")}),void e.$midInput.focus();for(var p={serviceCode:"GMES-CLIENT-KEYPART001",siteCode:r.siteCode,stationCode:e.station.stationCode,productNum:e.$productmark.val().toUpperCase(),createUser:e.userCode,modifyUser:e.userCode,subAssemblyBarcode:e.$midInput.val().toUpperCase(),subAssemblyFlag:1,statusECode:"10"},C=0;C<u;C++){var m=d[C];if(1==m.notNullFlag&&1!=m.invalid&&1!=m.statusEcode&&2!=m.statusEcode)return n.alert({type:"3",text:o.t("KEYPART.T.MSG_HAVE_NOT_NULL_DATA_SUBMIT",{keypartCode:m.keypartCode})}),void e.$lotBarCodeInput.focus().select();for(var v in m)if(m.hasOwnProperty(v)&&["createDate","createDateTime","modifyDate","modifyDateTime","invalid"].indexOf(v)<0){var f="items["+C+"]."+v;"statusEcode"!=v||""!=m[v]&&null!=m[v]&&m[v]?p[f]=m[v]:p[f]=0}}e.undoCount>0?myApp.confirm("数据录入不完整，确定要提交？",function(){a()}):a()}()})},emptySave:function(){function e(){var e={serviceCode:"GMES-CLIENT-KEYPART001",siteCode:r.siteCode,stationCode:t.station.stationCode,productNum:t.$productmark.val().toUpperCase(),createUser:t.userCode,modifyUser:t.userCode,subAssemblyBarcode:t.$midInput.val().toUpperCase(),subAssemblyFlag:1,statusECode:t.emptyNormalFlag};r.request({url:"restful/service/execute",data:e,success:function(e){"0"===e.returnCode?n.alert({text:"标记成功！"}):n.alert({type:"3",text:e.errorMessage}),t.table.clear().draw(),t.$allCount.text(0),t.$undoCount.text(0),t.$lotBarCodeInput.val(""),t.loadPageAgain()},error:function(){n.alert({type:"3",text:"标记失败！"}),t.table.clear().draw(),t.$allCount.text(0),t.$undoCount.text(0),t.$lotBarCodeInput.val(""),t.loadPageAgain()}})}var t=this;myApp.modal({title:"iME",text:"清单为空，跳过请标记：",buttons:[{text:"取消",onClick:function(){Sweet.mainView.router.loadPage("home.html")}},{text:"异常",onClick:function(){t.emptyNormalFlag="30",e()}},{text:"正常",bold:!0,onClick:function(){t.emptyNormalFlag="20",e()}}]})},pickermodalclose:function(e){e&&document.querySelector(e)&&document.querySelector(e).focus()}};e.exports=s}).call(t,a(4),a(37),a(77),a(36))}});
//# sourceMappingURL=pqs_keyComponentsOfPackagingCollection_4d86a75ce6cf8949286e.js.map